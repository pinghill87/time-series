---
title: "Univariate TS Models (ARIMA/SARIMA)"
code-fold: true
execute:
  cache: true
  freeze: auto
---

```{r}
#| warning: false
#| message: false

cat("Loading financial data...\n")

library(quantmod)
library(tidyverse)
library(zoo)
library(forecast)
library(tseries)

start_date <- as.Date("2019-01-01")
end_date   <- as.Date("2025-09-18")

# Safe loader

load_fred_data <- function(symbol) {
tryCatch(
getSymbols(symbol, src = "FRED", from = start_date, to = end_date,
auto.assign = FALSE),
error = function(e) { cat("FAILED:", symbol, "\n"); NULL }
)
}

# Load assets

sp500_data  <- load_fred_data("SP500")
vix_data    <- load_fred_data("VIXCLS")
btc_data    <- load_fred_data("CBBTCUSD")
nasdaq_data <- load_fred_data("NASDAQCOM")
usd_data    <- load_fred_data("DTWEXBGS")

# Merge only valid

merge_list <- list(
SP500   = sp500_data,
VIX     = vix_data,
Bitcoin = btc_data,
NASDAQ  = nasdaq_data,
USD     = usd_data
)
merge_list <- merge_list[!sapply(merge_list, is.null)]

cat("Loaded:", names(merge_list), "\n")

# Merge to zoo

price_zoo <- do.call(merge.zoo, merge_list)

# To dataframe

price_data <- fortify.zoo(price_zoo)
colnames(price_data) <- c("Date", names(merge_list))
price_data <- price_data |> na.omit()

cat(nrow(price_data), "rows loaded.\n")

# Differenced data function

get_series <- function(asset) price_data[[asset]]

get_diff_series <- function(asset) {
diff(log(price_data[[asset]])) |> na.omit()
}
```

```{r}
#| warning: false
#| message: false

cat("Fitting ARIMA + SARIMA models ONCE per asset...\n")

assets <- names(merge_list)

arima_models <- list()
sarima_models <- list()

for (a in assets) {
series <- get_diff_series(a)
cat("  Fitting ARIMA for", a, "\n")
arima_models[[a]] <- auto.arima(series, stepwise=TRUE, approximation=TRUE)

cat("  Fitting SARIMA for", a, "\n")
sarima_models[[a]] <- auto.arima(series, seasonal=TRUE,
stepwise=TRUE, approximation=TRUE)
}

cat("Model fitting complete.\n")

```

---

## HELPER FUNCTIONS  


```{r}
#| warning: false
#| message: false

plot_original_and_diff <- function(asset) {
par(mfrow=c(2,1))
plot(price_data$Date, price_data[[asset]], type="l",
main=paste(asset, "- Original"), col="steelblue")
plot(get_diff_series(asset), type="l",
main=paste(asset, "- First Difference"), col="red")
par(mfrow=c(1,1))
}

run_stationarity <- function(asset) {
print(adf.test(get_diff_series(asset)))
}

plot_acf_pacf <- function(asset) {
series <- get_diff_series(asset)
par(mfrow=c(1,2))
acf(series, main=paste(asset,"ACF"))
pacf(series, main=paste(asset,"PACF"))
par(mfrow=c(1,1))
}

run_arima_models <- function(asset) {
print(arima_models[[asset]])
}

run_arima_diagnostics <- function(asset) {
tsdiag(arima_models[[asset]])
}

forecast_arima_asset <- function(asset) {
plot(forecast(arima_models[[asset]], h=30),
main=paste(asset,"ARIMA Forecast"))
}

compare_benchmarks <- function(asset) {
s <- get_diff_series(asset)
list(
naive = naive(s, h=30),
snaive = snaive(s, h=30),
arima = forecast(arima_models[[asset]], h=30)
)
}

run_sarima_models <- function(asset) {
print(sarima_models[[asset]])
}

forecast_sarima_asset <- function(asset) {
plot(forecast(sarima_models[[asset]], h=30),
main=paste(asset,"SARIMA Forecast"))
}

seasonality_analysis <- function(asset) {
s <- ts(get_diff_series(asset), frequency=365)
plot(stl(s, "periodic"), main=paste(asset,"Seasonality"))
}

# FAST CV â€” no repeated auto.arima calls

cross_validate_sarima <- function(asset) {
series <- ts(get_diff_series(asset))
model <- sarima_models[[asset]]
ffun <- function(y, h) forecast(model, h=h)
e <- tsCV(series, ffun, h=1)
mean(e^2, na.rm=TRUE)
}

```



## Univariate Time Series Analysis

### Bitcoin

::: {.panel-tabset}

#### 1. Time Series + First Difference
```{r}
plot_original_and_diff("Bitcoin")
```

#### 2. Stationarity
```{r}
run_stationarity("Bitcoin")
```

#### 3. ACF & PACF
```{r}
plot_acf_pacf("Bitcoin")
```

#### 4. ARIMA
```{r}
run_arima_models("Bitcoin")
```

#### 5. Diagnostics
```{r}
run_arima_diagnostics("Bitcoin")
```

#### 6. Forecast
```{r}
forecast_arima_asset("Bitcoin")
```

#### 7. Benchmarks
```{r}
compare_benchmarks("Bitcoin")
```

#### 8. SARIMA
```{r}
run_sarima_models("Bitcoin")
```

#### 9. SARIMA Forecast
```{r}
forecast_sarima_asset("Bitcoin")
```

#### 10. Seasonality
```{r}
seasonality_analysis("Bitcoin")
```

#### 11. Cross Validation
```{r}
cross_validate_sarima("Bitcoin")
```

:::



### S&P 500

::: {.panel-tabset}

#### 1. Time Series + First Difference
```{r}
plot_original_and_diff("SP500")
```

#### 2. Stationarity
```{r}
run_stationarity("SP500")
```

#### 3. ACF & PACF
```{r}
plot_acf_pacf("SP500")
```

#### 4. ARIMA
```{r}
run_arima_models("SP500")
```

#### 5. Diagnostics
```{r}
run_arima_diagnostics("SP500")
```

#### 6. Forecast
```{r}
forecast_arima_asset("SP500")
```

#### 7. Benchmarks
```{r}
compare_benchmarks("SP500")
```

#### 8. SARIMA
```{r}
run_sarima_models("SP500")
```

#### 9. SARIMA Forecast
```{r}
forecast_sarima_asset("SP500")
```

#### 10. Seasonality
```{r}
seasonality_analysis("SP500")
```

#### 11. Cross Validation
```{r}
cross_validate_sarima("SP500")
```
:::

### NASDAQ
::: {.panel-tabset}

#### 1. Time Series + First Difference
```{r}
plot_original_and_diff("NASDAQ")
```

#### 2. Stationarity
```{r}
run_stationarity("NASDAQ")
```

#### 3. ACF & PACF
```{r}
plot_acf_pacf("NASDAQ")
```

#### 4. ARIMA
```{r}
run_arima_models("NASDAQ")
```

#### 5. Diagnostics
```{r}
run_arima_diagnostics("NASDAQ")
```

#### 6. Forecast
```{r}
forecast_arima_asset("NASDAQ")
```

#### 7. Benchmarks
```{r}
compare_benchmarks("NASDAQ")
```

#### 8. SARIMA
```{r}
run_sarima_models("NASDAQ")
```

#### 9. SARIMA Forecast
```{r}
forecast_sarima_asset("NASDAQ")
```

#### 10. Seasonality
```{r}
seasonality_analysis("NASDAQ")
```

#### 11. Cross Validation
```{r}
cross_validate_sarima("NASDAQ")
```
:::


### VIX
::: {.panel-tabset}

#### 1. Time Series + First Difference
```{r}
plot_original_and_diff("VIX")
```

#### 2. Stationarity
```{r}
run_stationarity("VIX")
```

#### 3. ACF & PACF
```{r}
plot_acf_pacf("VIX")
```

#### 4. ARIMA
```{r}
run_arima_models("VIX")
```

#### 5. Diagnostics
```{r}
run_arima_diagnostics("VIX")
```

#### 6. Forecast
```{r}
forecast_arima_asset("VIX")
```

#### 7. Benchmarks
```{r}
compare_benchmarks("VIX")
```

#### 8. SARIMA
```{r}
run_sarima_models("VIX")
```

#### 9. SARIMA Forecast
```{r}
forecast_sarima_asset("VIX")
```

#### 10. Seasonality
```{r}
seasonality_analysis("VIX")
```

#### 11. Cross Validation
```{r}
cross_validate_sarima("VIX")
```
:::


### USD
::: {.panel-tabset}

#### 1. Time Series + First Difference
```{r}
plot_original_and_diff("USD")
```

#### 2. Stationarity
```{r}
run_stationarity("USD")
```

#### 3. ACF & PACF
```{r}
plot_acf_pacf("USD")
```

#### 4. ARIMA
```{r}
run_arima_models("USD")
```

#### 5. Diagnostics
```{r}
run_arima_diagnostics("USD")
```

#### 6. Forecast
```{r}
forecast_arima_asset("USD")
```

#### 7. Benchmarks
```{r}
compare_benchmarks("USD")
```

#### 8. SARIMA
```{r}
run_sarima_models("USD")
```

#### 9. SARIMA Forecast
```{r}
forecast_sarima_asset("USD")
```

#### 10. Seasonality
```{r}
seasonality_analysis("USD")
```

#### 11. Cross Validation
```{r}
cross_validate_sarima("USD")
```
:::


