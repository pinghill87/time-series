---
title: "Data Visualization"
code-fold: true
format:
  html:
    toc: true
    toc-depth: 2
---

## Data Preperation

::: {.panel-tabset}

### Data Loading

```{r}
#| warning: false
#| message: false

# Core libraries
library(tidyverse)
library(quantmod)
library(lubridate)
library(zoo)
library(plotly)
library(pheatmap)


start_date <- as.Date("2019-01-01")
end_date   <- Sys.Date()

fred_symbols <- c(
  SP500   = "SP500",
  NASDAQ  = "NASDAQCOM",
  VIX     = "VIXCLS",
  USD     = "DTWEXBGS",
  Bitcoin = "CBBTCUSD",
  CPI     = "CPIAUCSL"
)

price_list <- list()

for (nm in names(fred_symbols)) {
  code <- fred_symbols[[nm]]
  cat(sprintf("  -> %s (%s)\n", nm, code))

  x <- tryCatch(
    getSymbols(code, src = "FRED",
               from = start_date, to = end_date,
               auto.assign = FALSE),
    error = function(e) NULL
  )

  if (!is.null(x) && nrow(x) > 0) {
    price_list[[nm]] <- x[, 1]
    cat(sprintf("     ✓ %d observations\n", nrow(x)))
  } else {
    cat("     ✗ failed to load\n")
  }
}


stopifnot(length(price_list) >= 2)

prices_xts <- do.call(merge, price_list)
colnames(prices_xts) <- names(price_list)

# Remove dates where everything is NA
prices_xts <- prices_xts[rowSums(is.na(prices_xts)) < ncol(prices_xts), ]

# Daily log returns (pairwise NA allowed)
returns_xts <- diff(log(prices_xts))



summary_tbl <- tibble(
  Metric = c(
    "Number of Days",
    "Number of Series",
    "Assets",
    "Date Range Start",
    "Date Range End"
  ),
  Value = c(
    nrow(prices_xts),
    ncol(prices_xts),
    paste(colnames(prices_xts), collapse = ", "),
    format(start(prices_xts), "%Y-%m-%d"),
    format(end(prices_xts), "%Y-%m-%d")
  )
)

summary_tbl

```

:::

## Market Overview – Bitcoin vs Traditional Assets 

::: {.panel-tabset}

### Normalized Line Chart

```{r}
#| warning: false
#| message: false

key_assets <- c("Bitcoin", "SP500", "NASDAQ", "VIX")
available  <- intersect(key_assets, colnames(prices_xts))

if (length(available) >= 2) {

  # Keep all series
  norm_xts <- prices_xts[, available]

  # Pull VIX out so it's not normalized with others
  if ("VIX" %in% colnames(norm_xts)) {
    vix_series <- norm_xts[, "VIX"]
    norm_xts   <- norm_xts[, colnames(norm_xts) != "VIX"]
  } else {
    vix_series <- NULL
  }

  # Normalize each series to 100
  norm_xts <- sweep(norm_xts, 2, as.numeric(norm_xts[1, ]), "/") * 100

  # NEW: separate object name
  fig_norm <- plot_ly()

  col_map <- c(Bitcoin = "#FF9500",
               SP500   = "#1f77b4",
               NASDAQ  = "#2ecc71")

  for (nm in colnames(norm_xts)) {
    ser <- na.omit(norm_xts[, nm])
    fig_norm <- fig_norm |>
      add_trace(
        x = index(ser),
        y = as.numeric(ser),
        type = "scatter",
        mode = "lines",
        name = nm,
        line = list(color = col_map[[nm]], width = 2)
      )
  }

  fig_norm

} else {
  cat("Not enough assets to build overview plot.\n")
}


```

### VIX Overlay
```{r}
#| warning: false
#| message: false

# Recreate normalized series (same logic as tab 1)

key_assets <- c("Bitcoin", "SP500", "NASDAQ", "VIX")
available  <- intersect(key_assets, colnames(prices_xts))

if (length(available) >= 2) {

  base_xts <- prices_xts[, available]

  if ("VIX" %in% colnames(base_xts)) {
    vix_series <- base_xts[, "VIX"]
    base_xts   <- base_xts[, colnames(base_xts) != "VIX"]
  } else {
    vix_series <- NULL
  }

  base_xts <- sweep(base_xts, 2, as.numeric(base_xts[1, ]), "/") * 100

  # Start fresh
  fig_vix <- plot_ly()

  col_map <- c(Bitcoin = "#FF9500",
               SP500   = "#1f77b4",
               NASDAQ  = "#2ecc71")

  for (nm in colnames(base_xts)) {
    ser <- na.omit(base_xts[, nm])
    fig_vix <- fig_vix |>
      add_trace(
        x = index(ser),
        y = as.numeric(ser),
        type = "scatter",
        mode = "lines",
        name = nm,
        line = list(color = col_map[[nm]], width = 2)
      )
  }

  # Add VIX
  if (!is.null(vix_series)) {
    vix_clean <- na.omit(vix_series)

    fig_vix <- fig_vix |>
      add_trace(
        x = index(vix_clean),
        y = as.numeric(vix_clean),
        type = "scatter",
        mode = "lines",
        name = "VIX (Fear Index)",
        yaxis = "y2",
        line = list(color = "#e74c3c", width = 2, dash = "dot")
      )
  }

  # Vertical crisis events
  events <- tibble::tibble(
    date  = as.Date(c("2020-03-12", "2022-02-24", "2022-11-11", "2023-03-10")),
    label = c("COVID Crash", "Ukraine War", "FTX Collapse", "SVB Crisis"),
    color = c("#dc2626", "#f97316", "#7c2d12", "#92400e")
  )

  for (i in seq_len(nrow(events))) {
    fig_vix <- fig_vix |>
      add_segments(
        x = events$date[i], xend = events$date[i],
        y = 0, yend = 1,
        yref = "paper",
        line = list(color = events$color[i], width = 1.5, dash = "dash"),
        showlegend = FALSE
      ) |>
      add_annotations(
        x = events$date[i],
        y = 0.95, yref = "paper",
        text = events$label[i],
        textangle = 90,
        showarrow = FALSE,
        font = list(size = 11, color = events$color[i])
      )
  }

  fig_vix <- fig_vix |>
    layout(
      title = list(
        text =
          "Bitcoin vs Traditional Markets<br><sub>Normalized to 100 at Start of Sample</sub>",
        x = 0.5
      ),
      xaxis = list(title = "Date"),
      yaxis = list(title = "Index Level (2019 = 100)"),
      yaxis2 = list(
        title = "VIX Level",
        overlaying = "y",
        side = "right"
      ),
      legend = list(
        orientation = "h",
        xanchor = "center",
        x = 0.5,
        y = 1.05
      ),
      hovermode = "x unified",
      template = "plotly_white"
    )

  fig_vix

} else {
  cat("Not enough assets to build VIX overlay.\n")
}

```

:::

## Correlations – BTC vs SP500, VIX, NASDAQ

::: {.panel-tabset}

### Rolling Correlations

```{r}
#| warning: false
#| message: false
#| fig.width: 9
#| fig.height: 5

required_ret <- c("Bitcoin", "SP500", "VIX", "NASDAQ")
have_ret     <- intersect(required_ret, colnames(returns_xts))

if (length(have_ret) >= 3 && nrow(returns_xts) > 60) {

  win <- 60

  # Convert returns to a tidy df
  ret_df <- returns_xts[, have_ret] |>
    as.data.frame() |>
    mutate(Date = index(returns_xts))

  # Rolling correlation function
  roll_corr <- function(x, y, k) {
    out <- rep(NA_real_, length(x))
    for (i in seq_len(length(x))) {
      if (i >= k) {
        seg_x <- x[(i - k + 1):i]
        seg_y <- y[(i - k + 1):i]
        if (sum(is.finite(seg_x) & is.finite(seg_y)) > k / 2) {
          out[i] <- cor(seg_x, seg_y, use = "pairwise.complete.obs")
        }
      }
    }
    out
  }

  # Compute rolling correlations
  ret_df <- ret_df |>
    mutate(
      BTC_SPX = roll_corr(ret_df$Bitcoin, ret_df$SP500, win),
      BTC_VIX = roll_corr(ret_df$Bitcoin, ret_df$VIX, win),
      BTC_NAS = roll_corr(ret_df$Bitcoin, ret_df$NASDAQ, win)
    ) |>
    select(Date, BTC_SPX, BTC_VIX, BTC_NAS) |>
    pivot_longer(
      cols = c(BTC_SPX, BTC_VIX, BTC_NAS),
      names_to = "Pair",
      values_to = "Correlation"
    ) |>
    drop_na()

  # Plot
  ggplot(ret_df, aes(Date, Correlation, color = Pair)) +
    geom_hline(yintercept = 0, color = "grey70", linetype = "dashed") +
    geom_line(linewidth = 1.1, alpha = 0.9) +
    scale_color_manual(
      values = c(
        BTC_SPX = "#e74c3c",
        BTC_VIX = "#3498db",
        BTC_NAS = "#2ecc71"
      ),
      labels = c(
        BTC_SPX = "BTC – S&P 500",
        BTC_VIX = "BTC – VIX",
        BTC_NAS = "BTC – NASDAQ"
      )
    ) +
    scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
    coord_cartesian(ylim = c(-1, 1)) +
    labs(
      title = "Rolling 60-Day Correlations",
      subtitle = "How Bitcoin's linkage to stocks, tech, and volatility changes over time",
      x = "Date",
      y = "Correlation",
      color = "Asset Pair"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      legend.position = "top",
      plot.title = element_text(face = "bold")
    )

} else {
  cat("Insufficient data for rolling correlations.\n")
}


```

### Heatmap – Rolling Pairwise Correlations

```{r}
#| warning: false
#| message: false

heat_assets <- c("Bitcoin", "SP500", "VIX", "USD")
heat_avail  <- intersect(heat_assets, colnames(returns_xts))

if (length(heat_avail) >= 2 && nrow(returns_xts) > 40) {

  w <- 40  # rolling window size

  ret_df <- as.data.frame(returns_xts[, heat_avail])
  ret_df$Date <- index(returns_xts)

  rows <- list()

  # Rolling windows every 10 days
  for (i in seq(w, nrow(ret_df), by = 10)) {

    seg <- ret_df[(i - w + 1):i, heat_avail, drop = FALSE]

    if (sum(complete.cases(seg)) > w / 2) {

      cm <- cor(seg, use = "pairwise.complete.obs")

      row <- list(Date = ret_df$Date[i])

      # Selected pairs
      if ("Bitcoin" %in% heat_avail && "SP500" %in% heat_avail)
        row[["BTC_SPX"]] <- cm["Bitcoin", "SP500"]

      if ("Bitcoin" %in% heat_avail && "VIX" %in% heat_avail)
        row[["BTC_VIX"]] <- cm["Bitcoin", "VIX"]

      if ("Bitcoin" %in% heat_avail && "USD" %in% heat_avail)
        row[["BTC_USD"]] <- cm["Bitcoin", "USD"]

      if ("SP500" %in% heat_avail && "VIX" %in% heat_avail)
        row[["SPX_VIX"]] <- cm["SP500", "VIX"]

      rows[[length(rows) + 1]] <- row
    }
  }

  # -------------------------------------------------------
  #   Build heatmap matrix
  # -------------------------------------------------------
  if (length(rows) > 0) {

    corr_df <- do.call(rbind, lapply(rows, as.data.frame))
    corr_df$Date <- as.Date(corr_df$Date)

    mat <- as.matrix(corr_df[, -1, drop = FALSE])

    # -------------------------------------------------------
    #   FIXED X-AXIS LABELS — clean and readable
    # -------------------------------------------------------
    n_cols <- ncol(t(mat))
    label_step <- 6   # show every 6th window (change to 10 or 12 if you want cleaner)

    col_labels <- ifelse(
      seq_len(n_cols) %% label_step == 0,
      format(corr_df$Date, "%Y-%m")[seq_len(n_cols)],
      ""
    )

    # -------------------------------------------------------
    #   Heatmap
    # -------------------------------------------------------
    pheatmap(
      t(mat),
      cluster_rows = FALSE,
      cluster_cols = FALSE,
      labels_col = col_labels,
      color = colorRampPalette(
        rev(c("#b2182b", "#ef8a62", "#fddbc7",
              "#f7f7f7",
              "#d1e5f0", "#67a9cf", "#2166ac"))
      )(100),
      breaks = seq(-1, 1, length.out = 101),
      main = "Rolling 40-Day Correlations Between Key Pairs",
      angle_col = 45,
      border_color = NA
    )

  } else {
    cat("Not enough rolling correlation windows for heatmap.\n")
  }

} else {
  cat("Insufficient data for heatmap correlations.\n")
}

```

:::

## Volatility

::: {.panel-tabset}

### BTC vs SP500 Vol

```{r}
#| warning: false
#| message: false
#| fig.width: 9
#| fig.height: 5

if (all(c("Bitcoin", "SP500") %in% colnames(returns_xts))) {

  # --- Compute vol ---
  vol <- tibble(
    Date = index(returns_xts),
    BTC  = rollapply(
      returns_xts[, "Bitcoin"], 30,
      sd, fill = NA, align = "right"
    ) * sqrt(252) * 100,
    SPX  = rollapply(
      returns_xts[, "SP500"], 30,
      sd, fill = NA, align = "right"
    ) * sqrt(252) * 100
  )

  # Keep only rows where at least one series is finite
  valid <- is.finite(vol$BTC) | is.finite(vol$SPX)

  if (sum(valid) == 0) {
    cat("No finite volatility values to plot.\n")

  } else {

    vol_plot <- vol[valid, ]

    # --- FIX: convert xts index and values to clean vectors ---
    dates <- as.Date(vol_plot$Date)
    btc   <- as.numeric(vol_plot$BTC)
    spx   <- as.numeric(vol_plot$SPX)

    # --- Base volatility plot ---
    plot(
      dates, btc,
      type = "l", col = "orange", lwd = 2,
      ylim = range(c(btc, spx), na.rm = TRUE),
      main = "Crisis Volatility Spillovers (30-Day Annualized Volatility)",
      xlab = "Date",
      ylab = "Volatility (%)"
    )

    lines(dates, spx, col = "blue", lwd = 2)
    grid()

    # --- VIX overlay ---
    if ("VIX" %in% colnames(prices_xts)) {

      vix_ma <- rollapply(
        prices_xts[, "VIX"], 30,
        mean, fill = NA, align = "right"
      )

      vix_vals <- as.numeric(vix_ma)
      vix_valid <- is.finite(vix_vals)

      if (any(vix_valid)) {

        # subset only finite values
        vix_ma    <- vix_ma[vix_valid]
        vix_dates <- as.Date(index(vix_ma))
        vix_vals  <- as.numeric(vix_ma)

        par(new = TRUE)

        plot(
          vix_dates, vix_vals,
          type = "l", col = "red", lwd = 1.5, lty = 2,
          axes = FALSE, xlab = "", ylab = ""
        )

        axis(4, col = "red", col.axis = "red")
        mtext("VIX Level (30-day MA)", side = 4, line = 3, col = "red")
      }
    }
  }

} else {
  cat("Need Bitcoin and SP500 returns for volatility plot.\n")
}

```


:::

## Macro Effects

::: {.panel-tabset}

### BTC & SP500 vs USD 
```{r}
#| warning: false
#| message: false
#| fig.width: 9
#| fig.height: 5

if (all(c("Bitcoin", "SP500") %in% colnames(prices_xts))) {

# Convert to monthly levels

m_prices <- tryCatch(
xts::to.monthly(prices_xts[, c("Bitcoin", "SP500", "USD")],
indexAt = "lastof", OHLC = FALSE),
error = function(e) NULL
)

if (!is.null(m_prices)) {
btc_m <- m_prices[, "Bitcoin"]
spx_m <- m_prices[, "SP500"]
usd_m <- if ("USD" %in% colnames(m_prices)) m_prices[, "USD"] else NULL




m_ret <- merge(diff(log(btc_m)), diff(log(spx_m)))
colnames(m_ret) <- c("BTC_ret", "SPX_ret")

df <- tibble(
  Date    = index(m_ret),
  BTC_ret = as.numeric(m_ret[, "BTC_ret"]),
  SPX_ret = as.numeric(m_ret[, "SPX_ret"])
)

if (!is.null(usd_m)) {
  df <- df |>
    left_join(
      tibble(
        Date = index(usd_m),
        USD  = as.numeric(usd_m)
      ),
      by = "Date"
    )
}

z <- function(x) {
  if (all(is.na(x)) || sd(x, na.rm = TRUE) == 0) return(rep(NA_real_, length(x)))
  as.numeric(scale(x))
}

df <- df |>
  mutate(
    BTC_z = z(BTC_ret),
    SPX_z = z(SPX_ret),
    USD_z = if (!is.null(usd_m)) z(USD) else NA_real_
  )

ggplot(df, aes(Date)) +
  geom_line(aes(y = BTC_z, color = "BTC (z)"), linewidth = 1) +
  geom_line(aes(y = SPX_z, color = "S&P 500 (z)"), linewidth = 1, alpha = 0.8) +
  geom_line(aes(y = USD_z, color = "USD Index (z)"),
            linewidth = 0.9, linetype = "dashed", alpha = 0.8) +
  labs(
    title = "Bitcoin & S&P vs USD Dollar Strength (Monthly, Z-scored)",
    subtitle = "When the dollar strengthens, risk assets often struggle",
    x = NULL,
    y = "Z-score (standardized units)",
    color = NULL
  ) +
  scale_color_manual(
    values = c(
      "BTC (z)"        = "#FF9500",
      "S&P 500 (z)"    = "#1f77b4",
      "USD Index (z)"  = "#7f7f7f"
    )
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "top")


} else {
cat("Could not build monthly macro overlay.\n")
}
} else {
cat("Need Bitcoin and SP500 price series for macro overlay.\n")
}

```

:::
