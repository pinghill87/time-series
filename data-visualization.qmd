---
title: "Data Visualization"
code-fold: true
format:
  html:
    toc: true
    toc-depth: 2
---

## Data Preperation

::: {.panel-tabset}

### Data Loading

```{r}
#| warning: false
#| message: false

# Core libraries
library(tidyverse)
library(quantmod)
library(lubridate)
library(zoo)
library(plotly)
library(pheatmap)


start_date <- as.Date("2019-01-01")
end_date   <- Sys.Date()

fred_symbols <- c(
  SP500   = "SP500",
  NASDAQ  = "NASDAQCOM",
  VIX     = "VIXCLS",
  USD     = "DTWEXBGS",
  Bitcoin = "CBBTCUSD",
  CPI     = "CPIAUCSL"
)

price_list <- list()

for (nm in names(fred_symbols)) {
  code <- fred_symbols[[nm]]
  cat(sprintf("  -> %s (%s)\n", nm, code))

  x <- tryCatch(
    getSymbols(code, src = "FRED",
               from = start_date, to = end_date,
               auto.assign = FALSE),
    error = function(e) NULL
  )

  if (!is.null(x) && nrow(x) > 0) {
    price_list[[nm]] <- x[, 1]
    cat(sprintf("     ✓ %d observations\n", nrow(x)))
  } else {
    cat("     ✗ failed to load\n")
  }
}


stopifnot(length(price_list) >= 2)

prices_xts <- do.call(merge, price_list)
colnames(prices_xts) <- names(price_list)

# Remove dates where everything is NA
prices_xts <- prices_xts[rowSums(is.na(prices_xts)) < ncol(prices_xts), ]

# Daily log returns (pairwise NA allowed)
returns_xts <- diff(log(prices_xts))



summary_tbl <- tibble(
  Metric = c(
    "Number of Days",
    "Number of Series",
    "Assets",
    "Date Range Start",
    "Date Range End"
  ),
  Value = c(
    nrow(prices_xts),
    ncol(prices_xts),
    paste(colnames(prices_xts), collapse = ", "),
    format(start(prices_xts), "%Y-%m-%d"),
    format(end(prices_xts), "%Y-%m-%d")
  )
)

summary_tbl

```

:::

## Market Overview

::: {.panel-tabset}



### Normalized Line Chart
```{r}
#| warning: false
#| message: false

key_assets <- c("Bitcoin", "SP500", "NASDAQ", "VIX")
available  <- intersect(key_assets, colnames(prices_xts))

if (length(available) >= 2) {

  # Extract assets (exclude VIX from normalization)
  norm_assets <- setdiff(available, "VIX")
  norm_xts <- prices_xts[, norm_assets]

  # Normalize each series independently to 100 at its first non-NA value
  for (col in colnames(norm_xts)) {
    series <- norm_xts[, col]
    first_valid_idx <- which(!is.na(series))[1]
    
    if (!is.na(first_valid_idx)) {
      first_valid_value <- as.numeric(series[first_valid_idx])
      norm_xts[, col] <- (series / first_valid_value) * 100
    }
  }

  # Build Plotly figure
  fig_norm <- plot_ly()

  col_map <- c(
    Bitcoin = "#FF9500",
    SP500   = "#1f77b4",
    NASDAQ  = "#2ecc71"
  )

  for (nm in colnames(norm_xts)) {
    ser <- na.omit(norm_xts[, nm])

    if (length(ser) > 0) {
      fig_norm <- fig_norm |>
        add_trace(
          x = index(ser),
          y = as.numeric(ser),
          type = "scatter",
          mode = "lines",
          name = nm,
          line = list(color = col_map[[nm]], width = 2)
        )
    }
  }
  
  # Add axis labels
  fig_norm <- fig_norm |>
    layout(
      xaxis = list(title = "Date"),
      yaxis = list(title = "Normalized Price (Base = 100)")
    )

  fig_norm

} else {
  cat("Not enough assets to build overview plot.")
}
```


Bitcoin has massively outperformed traditional equity indices since 2019, gaining over 3000% compared to roughly 300% for both S&P 500 and NASDAQ. The chart shows Bitcoin's extreme boom-bust cycles, with a huge run-up through 2021, a brutal 70% drawdown in 2022, and another rally into 2024-2025. Meanwhile, the S&P 500 and NASDAQ move almost identically, tracking each other closely throughout the entire period with much smoother, steadier growth. The gap between Bitcoin and equities keeps widening despite Bitcoin's volatility, showing the asymmetric return potential but also the stomach-churning drawdowns investors must endure.


### VIX Overlay
```{r}
#| warning: false
#| message: false

# Recreate normalized series (same logic as tab 1)

key_assets <- c("Bitcoin", "SP500", "NASDAQ", "VIX")
available  <- intersect(key_assets, colnames(prices_xts))

if (length(available) >= 2) {

  base_xts <- prices_xts[, available]

  if ("VIX" %in% colnames(base_xts)) {
    vix_series <- base_xts[, "VIX"]
    base_xts   <- base_xts[, colnames(base_xts) != "VIX"]
  } else {
    vix_series <- NULL
  }

  base_xts <- sweep(base_xts, 2, as.numeric(base_xts[1, ]), "/") * 100

  # Start fresh
  fig_vix <- plot_ly()

  col_map <- c(Bitcoin = "#FF9500",
               SP500   = "#1f77b4",
               NASDAQ  = "#2ecc71")

  for (nm in colnames(base_xts)) {
    ser <- na.omit(base_xts[, nm])
    fig_vix <- fig_vix |>
      add_trace(
        x = index(ser),
        y = as.numeric(ser),
        type = "scatter",
        mode = "lines",
        name = nm,
        line = list(color = col_map[[nm]], width = 2)
      )
  }

  # Add VIX
  if (!is.null(vix_series)) {
    vix_clean <- na.omit(vix_series)

    fig_vix <- fig_vix |>
      add_trace(
        x = index(vix_clean),
        y = as.numeric(vix_clean),
        type = "scatter",
        mode = "lines",
        name = "VIX (Fear Index)",
        yaxis = "y2",
        line = list(color = "#e74c3c", width = 2, dash = "dot")
      )
  }

  # Vertical crisis events
  events <- tibble::tibble(
    date  = as.Date(c("2020-03-12", "2022-02-24", "2022-11-11", "2023-03-10")),
    label = c("COVID Crash", "Ukraine War", "FTX Collapse", "SVB Crisis"),
    color = c("#dc2626", "#f97316", "#7c2d12", "#92400e")
  )

  for (i in seq_len(nrow(events))) {
    fig_vix <- fig_vix |>
      add_segments(
        x = events$date[i], xend = events$date[i],
        y = 0, yend = 1,
        yref = "paper",
        line = list(color = events$color[i], width = 1.5, dash = "dash"),
        showlegend = FALSE
      ) |>
      add_annotations(
        x = events$date[i],
        y = 0.95, yref = "paper",
        text = events$label[i],
        textangle = 90,
        showarrow = FALSE,
        font = list(size = 11, color = events$color[i])
      )
  }

  fig_vix <- fig_vix |>
    layout(
      title = list(
        text =
          "Bitcoin vs Traditional Markets<br><sub>Normalized to 100 at Start of Sample</sub>",
        x = 0.5
      ),
      xaxis = list(title = "Date"),
      yaxis = list(title = "Index Level (2019 = 100)"),
      yaxis2 = list(
        title = "VIX Level",
        overlaying = "y",
        side = "right"
      ),
      legend = list(
        orientation = "h",
        xanchor = "center",
        x = 0.5,
        y = 1.05
      ),
      hovermode = "x unified",
      template = "plotly_white"
    )

  fig_vix

} else {
  cat("Not enough assets to build VIX overlay.\n")
}

```

Major VIX spikes (red vertical annotations) mark key crisis moments: the COVID crash in March 2020 sent VIX above 80, the Ukraine war in early 2022, the FTX collapse in late 2022, and the SVB crisis in early 2023. Bitcoin often experiences sharp selloffs during these VIX explosions but doesn't always move in perfect sync. The COVID crash hit Bitcoin hard initially, but it recovered faster than traditional markets. During 2021's bull run, VIX stayed relatively calm even as Bitcoin was extremely volatile, reinforcing that Bitcoin volatility isn't always tied to broader market fear. Recent VIX spikes in 2024-2025 show muted Bitcoin reactions compared to earlier years, possibly indicating Bitcoin is maturing or attracting different types of investors less spooked by traditional market stress signals.

::: 

## Correlations – BTC vs SP500, VIX, NASDAQ

::: {.panel-tabset}

### Rolling Correlations

```{r}
#| warning: false
#| message: false
#| fig.width: 9
#| fig.height: 5

required_ret <- c("Bitcoin", "SP500", "VIX", "NASDAQ")
have_ret     <- intersect(required_ret, colnames(returns_xts))

if (length(have_ret) >= 3 && nrow(returns_xts) > 60) {

  win <- 60

  # Convert returns to a tidy df
  ret_df <- returns_xts[, have_ret] |>
    as.data.frame() |>
    mutate(Date = index(returns_xts))

  # Rolling correlation function
  roll_corr <- function(x, y, k) {
    out <- rep(NA_real_, length(x))
    for (i in seq_len(length(x))) {
      if (i >= k) {
        seg_x <- x[(i - k + 1):i]
        seg_y <- y[(i - k + 1):i]
        if (sum(is.finite(seg_x) & is.finite(seg_y)) > k / 2) {
          out[i] <- cor(seg_x, seg_y, use = "pairwise.complete.obs")
        }
      }
    }
    out
  }

  # Compute rolling correlations
  ret_df <- ret_df |>
    mutate(
      BTC_SPX = roll_corr(ret_df$Bitcoin, ret_df$SP500, win),
      BTC_VIX = roll_corr(ret_df$Bitcoin, ret_df$VIX, win),
      BTC_NAS = roll_corr(ret_df$Bitcoin, ret_df$NASDAQ, win)
    ) |>
    select(Date, BTC_SPX, BTC_VIX, BTC_NAS) |>
    pivot_longer(
      cols = c(BTC_SPX, BTC_VIX, BTC_NAS),
      names_to = "Pair",
      values_to = "Correlation"
    ) |>
    drop_na()

  # Plot
  ggplot(ret_df, aes(Date, Correlation, color = Pair)) +
    geom_hline(yintercept = 0, color = "grey70", linetype = "dashed") +
    geom_line(linewidth = 1.1, alpha = 0.9) +
    scale_color_manual(
      values = c(
        BTC_SPX = "#e74c3c",
        BTC_VIX = "#3498db",
        BTC_NAS = "#2ecc71"
      ),
      labels = c(
        BTC_SPX = "BTC – S&P 500",
        BTC_VIX = "BTC – VIX",
        BTC_NAS = "BTC – NASDAQ"
      )
    ) +
    scale_x_date(date_breaks = "1 year", date_labels = "%Y") +
    coord_cartesian(ylim = c(-1, 1)) +
    labs(
      title = "Rolling 60-Day Correlations",
      subtitle = "How Bitcoin's linkage to stocks, tech, and volatility changes over time",
      x = "Date",
      y = "Correlation",
      color = "Asset Pair"
    ) +
    theme_minimal(base_size = 12) +
    theme(
      legend.position = "top",
      plot.title = element_text(face = "bold")
    )

} else {
  cat("Insufficient data for rolling correlations.\n")
}


```

Bitcoin's relationship with traditional markets shifts dramatically over time. During 2020-2022, Bitcoin tracked closely with both NASDAQ and S&P 500 (correlations often above 0.5), behaving like a risk asset during the pandemic boom and subsequent Fed tightening. The VIX relationship is consistently negative, meaning Bitcoin tends to rise when market fear drops. Since late 2024, these correlations have weakened significantly, with Bitcoin recently decoupling from tech stocks. This suggests Bitcoin is transitioning from moving in lockstep with equities to establishing more independent price action.


### Heatmap – Rolling Pairwise Correlations

```{r}
#| warning: false
#| message: false

heat_assets <- c("Bitcoin", "SP500", "VIX", "USD")
heat_avail  <- intersect(heat_assets, colnames(returns_xts))

if (length(heat_avail) >= 2 && nrow(returns_xts) > 40) {

  w <- 40  # rolling window size

  ret_df <- as.data.frame(returns_xts[, heat_avail])
  ret_df$Date <- index(returns_xts)

  rows <- list()

  # Rolling windows every 10 days
  for (i in seq(w, nrow(ret_df), by = 10)) {

    seg <- ret_df[(i - w + 1):i, heat_avail, drop = FALSE]

    if (sum(complete.cases(seg)) > w / 2) {

      cm <- cor(seg, use = "pairwise.complete.obs")

      row <- list(Date = ret_df$Date[i])

      # Selected pairs
      if ("Bitcoin" %in% heat_avail && "SP500" %in% heat_avail)
        row[["BTC_SPX"]] <- cm["Bitcoin", "SP500"]

      if ("Bitcoin" %in% heat_avail && "VIX" %in% heat_avail)
        row[["BTC_VIX"]] <- cm["Bitcoin", "VIX"]

      if ("Bitcoin" %in% heat_avail && "USD" %in% heat_avail)
        row[["BTC_USD"]] <- cm["Bitcoin", "USD"]

      if ("SP500" %in% heat_avail && "VIX" %in% heat_avail)
        row[["SPX_VIX"]] <- cm["SP500", "VIX"]

      rows[[length(rows) + 1]] <- row
    }
  }

  # -------------------------------------------------------
  #   Build heatmap matrix
  # -------------------------------------------------------
  if (length(rows) > 0) {

    corr_df <- do.call(rbind, lapply(rows, as.data.frame))
    corr_df$Date <- as.Date(corr_df$Date)

    mat <- as.matrix(corr_df[, -1, drop = FALSE])

    # -------------------------------------------------------
    #   FIXED X-AXIS LABELS — clean and readable
    # -------------------------------------------------------
    n_cols <- ncol(t(mat))
    label_step <- 6   # show every 6th window (change to 10 or 12 if you want cleaner)

    col_labels <- ifelse(
      seq_len(n_cols) %% label_step == 0,
      format(corr_df$Date, "%Y-%m")[seq_len(n_cols)],
      ""
    )

    # -------------------------------------------------------
    #   Heatmap
    # -------------------------------------------------------
    pheatmap(
      t(mat),
      cluster_rows = FALSE,
      cluster_cols = FALSE,
      labels_col = col_labels,
      color = colorRampPalette(
        rev(c("#b2182b", "#ef8a62", "#fddbc7",
              "#f7f7f7",
              "#d1e5f0", "#67a9cf", "#2166ac"))
      )(100),
      breaks = seq(-1, 1, length.out = 101),
      main = "Rolling 40-Day Correlations Between Key Pairs",
      angle_col = 45,
      border_color = NA
    )

  } else {
    cat("Not enough rolling correlation windows for heatmap.\n")
  }

} else {
  cat("Insufficient data for heatmap correlations.\n")
}

```

The heatmap shows sustained positive correlation between Bitcoin and S&P 500 (red band at top) throughout most of the period, particularly strong from 2020-2023. Bitcoin's relationship with VIX remains persistently negative (blue band), confirming inverse movement with market stress. The S&P 500 and VIX relationship is also consistently negative (bottom blue band), which is expected since VIX measures equity market fear. The intensity of colors varies over time, with some periods showing stronger relationships than others, but the directional patterns hold steady.

:::

## Volatility

::: {.panel-tabset}

### BTC vs SP500 Vol

```{r}
#| warning: false
#| message: false


# Debug: Check what we're working with



# Try converting differently
sp500_vec <- as.vector(returns_xts[, "SP500"])
btc_vec <- as.vector(returns_xts[, "Bitcoin"])

if (all(c("Bitcoin", "SP500") %in% colnames(returns_xts))) {

  # Calculate volatility using vectors directly with na.rm = TRUE
  vol <- tibble(
    Date = index(returns_xts)
  )

  vol$BTC <- rollapply(
    zoo(btc_vec, index(returns_xts)), 30,
    function(x) sd(x, na.rm = TRUE), 
    fill = NA, align = "right"
  ) %>% as.numeric() * sqrt(252) * 100

  vol$SPX <- rollapply(
    zoo(sp500_vec, index(returns_xts)), 30,
    function(x) sd(x, na.rm = TRUE),
    fill = NA, align = "right"
  ) %>% as.numeric() * sqrt(252) * 100


  # Drop rows where both are NA
  vol <- vol %>% 
    filter(is.finite(BTC) | is.finite(SPX))

  if (nrow(vol) == 0) {
    cat("No finite volatility values to plot.\n")

  } else {

    fig_vol <- plot_ly()
    
    # Add Bitcoin volatility
    if (sum(is.finite(vol$BTC)) > 0) {
      fig_vol <- fig_vol |>
        add_trace(
          x = vol$Date,
          y = vol$BTC,
          type = "scatter",
          mode = "lines",
          name = "Bitcoin",
          line = list(color = "#FF9500", width = 2),
          yaxis = "y1"
        )
    }
    
    # Add SP500 volatility
    if (sum(is.finite(vol$SPX)) > 0) {
      fig_vol <- fig_vol |>
        add_trace(
          x = vol$Date,
          y = vol$SPX,
          type = "scatter",
          mode = "lines",
          name = "SP500",
          line = list(color = "#1f77b4", width = 2),
          yaxis = "y1"
        )
    }

    # Add VIX if available
    if ("VIX" %in% colnames(prices_xts)) {

      vix_vec <- as.vector(prices_xts[, "VIX"])
      
      vix_ma <- rollapply(
        zoo(vix_vec, index(prices_xts)), 30,
        function(x) mean(x, na.rm = TRUE),
        fill = NA, align = "right"
      )

      vix_df <- tibble(
        Date = index(vix_ma),
        VIX = as.numeric(vix_ma)
      ) %>%
        filter(is.finite(VIX))

      if (nrow(vix_df) > 0) {
        fig_vol <- fig_vol |>
          add_trace(
            x = vix_df$Date,
            y = vix_df$VIX,
            type = "scatter",
            mode = "lines",
            name = "VIX (30-day MA)",
            line = list(color = "red", width = 1.5, dash = "dash"),
            yaxis = "y2"
          )
      }
    }
    
    # Layout with dual y-axes
    fig_vol <- fig_vol |>
      layout(
        title = "Crisis Volatility Spillovers (30-Day Annualized Volatility)",
        xaxis = list(title = "Date"),
        yaxis = list(
          title = "Volatility (%)",
          side = "left"
        ),
        yaxis2 = list(
          title = "VIX Level (30-day MA)",
          overlaying = "y",
          side = "right",
          showgrid = FALSE
        )
      )

    fig_vol

  }

} else {
  cat("Need Bitcoin and SP500 returns for volatility plot.\n")
}

```



Bitcoin's volatility consistently runs 2-4x higher than the S&P 500, with dramatic spikes exceeding 160% during the March 2020 crash and 2021-2022 crypto cycle. The VIX tracks closely with S&P 500 stress but shows weaker correlation with Bitcoin's swings, suggesting Bitcoin operates independently from traditional market panic. Since mid-2023, Bitcoin's volatility has compressed to 30-40% but still remains roughly double that of equities.


:::

## Macro Effects

::: {.panel-tabset}

### BTC & SP500 vs USD 
```{r}
#| warning: false
#| message: false
#| fig.width: 9
#| fig.height: 5

if (all(c("Bitcoin", "SP500") %in% colnames(prices_xts))) {

# Convert to monthly levels

m_prices <- tryCatch(
xts::to.monthly(prices_xts[, c("Bitcoin", "SP500", "USD")],
indexAt = "lastof", OHLC = FALSE),
error = function(e) NULL
)

if (!is.null(m_prices)) {
btc_m <- m_prices[, "Bitcoin"]
spx_m <- m_prices[, "SP500"]
usd_m <- if ("USD" %in% colnames(m_prices)) m_prices[, "USD"] else NULL




m_ret <- merge(diff(log(btc_m)), diff(log(spx_m)))
colnames(m_ret) <- c("BTC_ret", "SPX_ret")

df <- tibble(
  Date    = index(m_ret),
  BTC_ret = as.numeric(m_ret[, "BTC_ret"]),
  SPX_ret = as.numeric(m_ret[, "SPX_ret"])
)

if (!is.null(usd_m)) {
  df <- df |>
    left_join(
      tibble(
        Date = index(usd_m),
        USD  = as.numeric(usd_m)
      ),
      by = "Date"
    )
}

z <- function(x) {
  if (all(is.na(x)) || sd(x, na.rm = TRUE) == 0) return(rep(NA_real_, length(x)))
  as.numeric(scale(x))
}

df <- df |>
  mutate(
    BTC_z = z(BTC_ret),
    SPX_z = z(SPX_ret),
    USD_z = if (!is.null(usd_m)) z(USD) else NA_real_
  )

ggplot(df, aes(Date)) +
  geom_line(aes(y = BTC_z, color = "BTC (z)"), linewidth = 1) +
  geom_line(aes(y = SPX_z, color = "S&P 500 (z)"), linewidth = 1, alpha = 0.8) +
  geom_line(aes(y = USD_z, color = "USD Index (z)"),
            linewidth = 0.9, linetype = "dashed", alpha = 0.8) +
  labs(
    title = "Bitcoin & S&P vs USD Dollar Strength (Monthly, Z-scored)",
    subtitle = "When the dollar strengthens, risk assets often struggle",
    x = NULL,
    y = "Z-score (standardized units)",
    color = NULL
  ) +
  scale_color_manual(
    values = c(
      "BTC (z)"        = "#FF9500",
      "S&P 500 (z)"    = "#1f77b4",
      "USD Index (z)"  = "#7f7f7f"
    )
  ) +
  theme_minimal(base_size = 12) +
  theme(legend.position = "top")


} else {
cat("Could not build monthly macro overlay.\n")
}
} else {
cat("Need Bitcoin and SP500 price series for macro overlay.\n")
}

```

When the dollar strengthens (gray dashed line spikes upward), both Bitcoin and S&P 500 often experience downward pressure, visible in the synchronized drops during 2022 and late 2024. This makes sense since a strong dollar typically signals risk-off sentiment and tighter financial conditions globally. Both assets show similar sensitivity to dollar movements, reinforcing that Bitcoin still behaves somewhat like a risk asset responsive to macro liquidity conditions. The z-scored format (standardized units) makes it easier to compare movements across different scales.

:::

## Conclusion

### Key Findings from Market Behavior Analysis

This data visualization page reveals critical insights into how Bitcoin interacts with traditional financial markets across multiple dimensions. Bitcoin has delivered extraordinary returns since 2019, gaining over 3000% compared to roughly 300% for both S&P 500 and NASDAQ, but this outperformance comes with substantially higher risk. Bitcoin's volatility consistently runs 2-4x higher than equities, with dramatic spikes exceeding 160% annualized volatility during the March 2020 crash and 2021-2022 crypto cycle, while the S&P 500 maintains relatively stable volatility between 10-30%.

### Evolution of Market Relationships
The correlation analysis demonstrates that Bitcoin's relationship with traditional markets has undergone significant transformation. During 2020-2022, Bitcoin tracked closely with both NASDAQ and S&P 500 (correlations often above 0.5), behaving like a risk asset during the pandemic boom and subsequent Fed tightening. However, since late 2024, these correlations have weakened significantly, suggesting Bitcoin is transitioning from moving in lockstep with equities to establishing more independent price action. The VIX relationship remains consistently negative throughout, meaning Bitcoin tends to rise when market fear drops, though recent years show weaker correlation with Bitcoin's swings compared to traditional market stress signals.

### Macro Sensitivity and Crisis Dynamics
Bitcoin demonstrates clear sensitivity to macroeconomic conditions, particularly dollar strength. When the dollar strengthens, both Bitcoin and S&P 500 often experience downward pressure, reinforcing that Bitcoin still behaves somewhat like a risk asset responsive to macro liquidity conditions. Major VIX spikes during crisis moments (COVID crash, Ukraine war, FTX collapse, SVB crisis) consistently trigger sharp selloffs across markets, but Bitcoin's reaction to these traditional market fear signals has become more muted in 2024-2025 compared to earlier years. This pattern suggests possible market maturation or a shift in investor composition less spooked by traditional equity market stress.

### Implications for Spillover Analysis

These visualizations establish the empirical foundation for understanding volatility spillovers between crypto and traditional markets. Bitcoin's high but declining volatility, evolving correlations with equities, persistent negative relationship with market fear indicators, and sensitivity to dollar strength all point to complex transmission mechanisms that warrant deeper investigation through formal time series modeling. The evidence suggests Bitcoin is neither fully independent nor perfectly correlated with traditional markets, occupying a dynamic middle ground where spillover effects likely vary by market regime, crisis type, and time horizon. This sets the stage for the subsequent univariate, multivariate, and volatility modeling work that will quantify these relationships more precisely.
