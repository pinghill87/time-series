<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.43">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Time Series Analysis – Multivariate TS Models (ARIMAX/SARIMAX/VAR)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


</head>

<body class="nav-fixed fullcontent">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">Time Series Analysis</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About You</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./introduction.html"> 
<span class="menu-text">Introduction</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./data-sources.html"> 
<span class="menu-text">Data Sources</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./data-visualization.html"> 
<span class="menu-text">Data Visualization</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./eda.html"> 
<span class="menu-text">Exploratory Data Analysis</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./univariate-ts-models.html"> 
<span class="menu-text">Univariate TS Models (ARIMA/SARIMA)</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="./multivariate-ts-models.html" aria-current="page"> 
<span class="menu-text">Multivariate TS Models (ARIMAX/SARIMAX/VAR)</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./financial-ts-models.html"> 
<span class="menu-text">Financial Time Series Models (ARCH/GARCH)</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./deep-learning-ts.html"> 
<span class="menu-text">Deep Learning for TS</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./other-topics.html"> 
<span class="menu-text">Other: Interrupted TS/ARFIMA/Spectral Analysis</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./conclusions.html"> 
<span class="menu-text">Conclusions</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Multivariate TS Models (ARIMAX/SARIMAX/VAR)</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="introduction" class="level2">
<h2 class="anchored" data-anchor-id="introduction">Introduction</h2>
<p>In this analysis, we investigate the relationships between cryptocurrency markets (Bitcoin), traditional equity markets (S&amp;P 500), market volatility (VIX), and macroeconomic indicators (CPI). Understanding these relationships is crucial for portfolio diversification, risk management, and forecasting in modern financial markets.</p>
</section>
<section id="literature-review" class="level2">
<h2 class="anchored" data-anchor-id="literature-review">Literature Review</h2>
<section id="background-and-variable-selection" class="level3">
<h3 class="anchored" data-anchor-id="background-and-variable-selection">Background and Variable Selection</h3>
<p>Financial markets exhibit complex interdependencies that have evolved significantly with the emergence of cryptocurrency markets. According to <strong>Nakamoto (2008)</strong> and subsequent cryptocurrency research, Bitcoin was designed as a decentralized alternative to traditional fiat currencies. However, empirical studies by <strong>Baur &amp; Dimpfl (2018)</strong> show that Bitcoin increasingly behaves like a traditional financial asset, responding to macroeconomic and market conditions.</p>
<p>The <strong>S&amp;P 500</strong> serves as a broad measure of U.S. equity market performance and overall economic health. Research by <strong>Corbet et al.&nbsp;(2018)</strong> demonstrates significant spillover effects between traditional equity markets and cryptocurrency markets, particularly during periods of market stress. During the COVID-19 pandemic, both Bitcoin and the S&amp;P 500 experienced simultaneous crashes, suggesting increasing correlation.</p>
<p>The <strong>VIX</strong> (CBOE Volatility Index), often called the “fear gauge,” measures expected market volatility. Studies by <strong>Whaley (2009)</strong> establish the VIX as a leading indicator of market sentiment. Recent research by <strong>Smales (2019)</strong> shows that Bitcoin exhibits increased correlation with traditional markets during high-volatility periods, suggesting that market fear affects all asset classes. The inverse relationship between VIX and S&amp;P 500 is well-documented, with VIX typically rising when stock prices fall.</p>
<p>The <strong>U.S. Dollar Index (USD)</strong> summarizes the value of the U.S. dollar against a basket of major currencies. Dollar strength is linked to global risk sentiment and capital flows. A stronger dollar is often associated with tighter global financial conditions and may put pressure on risky assets such as equities and cryptocurrencies.</p>
<p><strong>Variable Justification</strong>:</p>
<p>Based on this literature, I focus on the following relationships:</p>
<ol type="1">
<li><strong>Bitcoin returns</strong> may be influenced by traditional market performance (SP500) and market volatility/fear (VIX).</li>
<li><strong>SP500 and VIX</strong> have a well-documented inverse relationship—when stocks fall, fear rises.</li>
<li><strong>Dollar strength (USD)</strong> may be related to risk sentiment and interact with equity and crypto markets.</li>
<li>These variables likely exhibit <strong>dynamic and possibly bidirectional</strong> relationships, motivating multivariate time series models.</li>
</ol>
<hr>
</section>
</section>
<section id="key-research-questions" class="level2">
<h2 class="anchored" data-anchor-id="key-research-questions">Key Research Questions</h2>
<ol type="1">
<li><strong>How does market fear (VIX) affect Bitcoin and S&amp;P 500 returns?</strong></li>
<li><strong>What is the relationship between traditional markets (S&amp;P 500) and cryptocurrency markets (Bitcoin)?</strong></li>
<li><strong>Does including multiple series (Bitcoin, SP500, VIX, USD) in multivariate models improve forecasting compared to univariate ARIMA?</strong></li>
<li><strong>Do these variables exhibit bidirectional causality (VAR) or mainly unidirectional effects (ARIMAX)?</strong></li>
</ol>
<hr>
</section>
<section id="proposed-models" class="level2">
<h2 class="anchored" data-anchor-id="proposed-models">Proposed Models</h2>
<p>Based on the literature and data availability, I estimate the following models:</p>
<p><strong>Model 1 (ARIMAX)</strong>: Bitcoin_ret ~ SP500_ret + VIX_ret<br>
- <em>Rationale</em>: Test whether Bitcoin returns are driven by traditional market performance and market fear.</p>
<p><strong>Model 2 (ARIMAX)</strong>: SP500_ret ~ Bitcoin_ret + VIX_ret<br>
- <em>Rationale</em>: Examine how cryptocurrency returns and volatility interact with equity returns.</p>
<p><strong>Model 3 (ARIMAX)</strong>: VIX_ret ~ Bitcoin_ret + SP500_ret<br>
- <em>Rationale</em>: Test whether movements in equities and Bitcoin help explain changes in implied volatility.</p>
<p><strong>Model 4 (ARIMAX)</strong>: USD_ret ~ Bitcoin_ret + SP500_ret<br>
- <em>Rationale</em>: Explore how equity and crypto markets relate to changes in the broad U.S. dollar index.</p>
<p><strong>Model 5 (VAR)</strong>: [Bitcoin_ret, SP500_ret, VIX_ret]<br>
- <em>Rationale</em>: Capture bidirectional relationships and dynamic interactions among cryptocurrency, equities, and volatility.</p>
<p><strong>For this homework, I focus primarily on the ARIMAX models (Models 1–4) and a VAR model including Bitcoin, SP500, and VIX.</strong></p>
<hr>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">suppressPackageStartupMessages</span>({</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(quantmod); <span class="fu">library</span>(zoo); <span class="fu">library</span>(xts)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse); <span class="fu">library</span>(forecast); <span class="fu">library</span>(tseries)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>start_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2019-01-01"</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>end_date   <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(<span class="st">"2025-09-18"</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="co"># helper (safe) loader</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>load_fred_data <span class="ot">&lt;-</span> <span class="cf">function</span>(symbol, start, end) {</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="fu">tryCatch</span>({</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="fu">getSymbols</span>(symbol, <span class="at">src =</span> <span class="st">"FRED"</span>, <span class="at">from =</span> start, <span class="at">to =</span> end, <span class="at">auto.assign =</span> <span class="cn">FALSE</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>}, <span class="at">error =</span> <span class="cf">function</span>(e) {</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Warning: Could not load %s (%s)</span><span class="sc">\n</span><span class="st">"</span>, symbol, e<span class="sc">$</span>message))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="cn">NULL</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Load and merge only if needed</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">exists</span>(<span class="st">"price_data"</span>) <span class="sc">||</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="sc">!</span><span class="fu">all</span>(<span class="fu">c</span>(<span class="st">"Date"</span>,<span class="st">"SP500"</span>,<span class="st">"VIX"</span>,<span class="st">"Bitcoin"</span>,<span class="st">"USD"</span>) <span class="sc">%in%</span> <span class="fu">names</span>(price_data))) {</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>sp500_data <span class="ot">&lt;-</span> <span class="fu">load_fred_data</span>(<span class="st">"SP500"</span>,    start_date, end_date)</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>vix_data   <span class="ot">&lt;-</span> <span class="fu">load_fred_data</span>(<span class="st">"VIXCLS"</span>,   start_date, end_date)</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>btc_data   <span class="ot">&lt;-</span> <span class="fu">load_fred_data</span>(<span class="st">"CBBTCUSD"</span>, start_date, end_date)</span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>usd_data   <span class="ot">&lt;-</span> <span class="fu">load_fred_data</span>(<span class="st">"DTWEXBGS"</span>, start_date, end_date)  <span class="co"># NEW: USD</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>merged <span class="ot">&lt;-</span> <span class="fu">merge</span>(</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="at">SP500   =</span> sp500_data,</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a><span class="at">VIX     =</span> vix_data,</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a><span class="at">Bitcoin =</span> btc_data,</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="at">USD     =</span> usd_data</span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>price_data <span class="ot">&lt;-</span> <span class="fu">fortify.zoo</span>(merged)</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="fu">colnames</span>(price_data) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Date"</span>,<span class="st">"SP500"</span>,<span class="st">"VIX"</span>,<span class="st">"Bitcoin"</span>,<span class="st">"USD"</span>)</span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>price_data <span class="ot">&lt;-</span> price_data <span class="sc">|&gt;</span> <span class="fu">arrange</span>(Date) <span class="sc">|&gt;</span> <span class="fu">na.omit</span>()</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Daily log-returns (stationary)</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>returns <span class="ot">&lt;-</span> price_data <span class="sc">|&gt;</span></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="fu">mutate</span>(</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="at">SP500_ret   =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(<span class="fu">log</span>(SP500))),</span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a><span class="at">VIX_ret     =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(<span class="fu">log</span>(VIX))),</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a><span class="at">Bitcoin_ret =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(<span class="fu">log</span>(Bitcoin))),</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="at">USD_ret     =</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">diff</span>(<span class="fu">log</span>(USD)))  <span class="co"># NEW: USD returns</span></span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="fu">na.omit</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="bitcoin" class="level2">
<h2 class="anchored" data-anchor-id="bitcoin">Bitcoin</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true">Visualization</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false">Variable Selection</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false">Initial Selection</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false">Cross Validation</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false">Model Creation</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" role="tab" aria-controls="tabset-1-6" aria-selected="false">Forecasting</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(price_data, <span class="fu">aes</span>(Date, Bitcoin)) <span class="sc">+</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Bitcoin (Level)"</span>, <span class="at">x=</span><span class="cn">NULL</span>, <span class="at">y=</span><span class="cn">NULL</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(returns, <span class="fu">aes</span>(Date, Bitcoin_ret)) <span class="sc">+</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"Bitcoin (Log-Returns)"</span>, <span class="at">x=</span><span class="cn">NULL</span>, <span class="at">y=</span><span class="cn">NULL</span>)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(p1, p2, <span class="at">nrow=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/btc-viz-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Quick sanity checks for using SP500_ret &amp; VIX_ret as xreg</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>cm <span class="ot">&lt;-</span> <span class="fu">cor</span>(returns[, <span class="fu">c</span>(<span class="st">"Bitcoin_ret"</span>,<span class="st">"SP500_ret"</span>,<span class="st">"VIX_ret"</span>)], <span class="at">use=</span><span class="st">"complete.obs"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">round</span>(cm, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            Bitcoin_ret SP500_ret VIX_ret
Bitcoin_ret       1.000     0.283  -0.221
SP500_ret         0.283     1.000  -0.728
VIX_ret          -0.221    -0.728   1.000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Stationarity (ADF) on returns</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>adf_btc <span class="ot">&lt;-</span> <span class="fu">adf.test</span>(returns<span class="sc">$</span>Bitcoin_ret)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>adf_spx <span class="ot">&lt;-</span> <span class="fu">adf.test</span>(returns<span class="sc">$</span>SP500_ret)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>adf_vix <span class="ot">&lt;-</span> <span class="fu">adf.test</span>(returns<span class="sc">$</span>VIX_ret)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"ADF p-values → BTC: %.4f | SPX: %.4f | VIX: %.4f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>adf_btc<span class="sc">$</span>p.value, adf_spx<span class="sc">$</span>p.value, adf_vix<span class="sc">$</span>p.value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>ADF p-values → BTC: 0.0100 | SPX: 0.0100 | VIX: 0.0100</code></pre>
</div>
</div>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Assemble y and scaled xreg</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>y   <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(returns<span class="sc">$</span>Bitcoin_ret)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>X   <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(returns[, <span class="fu">c</span>(<span class="st">"SP500_ret"</span>,<span class="st">"VIX_ret"</span>)])</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>XS  <span class="ot">&lt;-</span> <span class="fu">scale</span>(X)  <span class="co"># keep attributes for future scaling</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 1 — Auto.ARIMA with xreg</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>m_btc_auto <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">auto.arima</span>(y, <span class="at">xreg =</span> XS, <span class="at">seasonal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AUTO.ARIMA with xreg summary:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(m_btc_auto))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>AUTO.ARIMA with xreg summary:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y 
Regression with ARIMA(0,0,1) errors 

Coefficients:
          ma1  intercept  SP500_ret  VIX_ret
      -0.0509      2e-03     0.0106  -0.0014
s.e.   0.0239      9e-04     0.0014   0.0014

sigma^2 = 0.001532:  log likelihood = 3038.74
AIC=-6067.48   AICc=-6067.44   BIC=-6040.38

Training set error measures:
                        ME       RMSE        MAE      MPE     MAPE      MASE
Training set -2.889967e-07 0.03909278 0.02628258 84.64458 181.4527 0.6305882
                     ACF1
Training set -0.001210254</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Method 2 — Manual: OLS then ARIMA on residuals, finally ARIMAX with that order</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>ols <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> XS)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>res <span class="ot">&lt;-</span> <span class="fu">resid</span>(ols)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>res_arima <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">auto.arima</span>(res, <span class="at">seasonal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>ord <span class="ot">&lt;-</span> <span class="fu">arimaorder</span>(res_arima)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>m_btc_manual <span class="ot">&lt;-</span> <span class="fu">Arima</span>(y, <span class="at">order =</span> ord, <span class="at">xreg =</span> XS, <span class="at">include.mean =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">MANUAL ARIMAX summary:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(m_btc_manual))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
MANUAL ARIMAX summary:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y 
Regression with ARIMA(0,0,1) errors 

Coefficients:
          ma1  intercept  SP500_ret  VIX_ret
      -0.0509      2e-03     0.0106  -0.0014
s.e.   0.0239      9e-04     0.0014   0.0014

sigma^2 = 0.001532:  log likelihood = 3038.74
AIC=-6067.48   AICc=-6067.44   BIC=-6040.38

Training set error measures:
                        ME       RMSE        MAE      MPE     MAPE      MASE
Training set -2.889967e-07 0.03909278 0.02628258 84.64458 181.4527 0.6305882
                     ACF1
Training set -0.001210254</code></pre>
</div>
</div>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>H <span class="ot">&lt;-</span> <span class="dv">20</span>           <span class="co"># horizon</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>K <span class="ot">&lt;-</span> <span class="dv">10</span>           <span class="co"># folds</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="fu">length</span>(y)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>rmse_auto <span class="ot">&lt;-</span> <span class="fu">c</span>(); rmse_manual <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>tr_end <span class="ot">&lt;-</span> n <span class="sc">-</span> H<span class="sc">*</span>(K <span class="sc">-</span> i <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (tr_end <span class="sc">&lt;</span> <span class="dv">250</span>) <span class="cf">break</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>y_tr <span class="ot">&lt;-</span> y[<span class="dv">1</span><span class="sc">:</span>tr_end]</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>y_te <span class="ot">&lt;-</span> y[(tr_end<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(tr_end<span class="sc">+</span>H)]</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>X_tr <span class="ot">&lt;-</span> XS[<span class="dv">1</span><span class="sc">:</span>tr_end, , drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>X_te <span class="ot">&lt;-</span> XS[(tr_end<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(tr_end<span class="sc">+</span>H), , drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="co"># auto</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>fit_a <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">auto.arima</span>(y_tr, <span class="at">xreg =</span> X_tr, <span class="at">seasonal =</span> <span class="cn">FALSE</span>), <span class="at">silent=</span><span class="cn">TRUE</span>)</span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(fit_a, <span class="st">"try-error"</span>)) {</span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>fc_a <span class="ot">&lt;-</span> <span class="fu">forecast</span>(fit_a, <span class="at">xreg =</span> X_te, <span class="at">h =</span> H)</span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>rmse_auto <span class="ot">&lt;-</span> <span class="fu">c</span>(rmse_auto, <span class="fu">sqrt</span>(<span class="fu">mean</span>((y_te <span class="sc">-</span> <span class="fu">as.numeric</span>(fc_a<span class="sc">$</span>mean))<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a><span class="co"># manual (use the order we found above)</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>fit_m <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">Arima</span>(y_tr, <span class="at">order =</span> ord, <span class="at">xreg =</span> X_tr, <span class="at">include.mean =</span> <span class="cn">TRUE</span>), <span class="at">silent=</span><span class="cn">TRUE</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(fit_m, <span class="st">"try-error"</span>)) {</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>fc_m <span class="ot">&lt;-</span> <span class="fu">forecast</span>(fit_m, <span class="at">xreg =</span> X_te, <span class="at">h =</span> H)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>rmse_manual <span class="ot">&lt;-</span> <span class="fu">c</span>(rmse_manual, <span class="fu">sqrt</span>(<span class="fu">mean</span>((y_te <span class="sc">-</span> <span class="fu">as.numeric</span>(fc_m<span class="sc">$</span>mean))<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>cv_df <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a><span class="at">Fold =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(<span class="fu">length</span>(rmse_auto), <span class="fu">length</span>(rmse_manual)),</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a><span class="at">Auto  =</span> rmse_auto,</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a><span class="at">Manual=</span> rmse_manual</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="sc">-</span>Fold, <span class="at">names_to=</span><span class="st">"Model"</span>, <span class="at">values_to=</span><span class="st">"RMSE"</span>)</span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">na.omit</span>(cv_df), <span class="fu">aes</span>(Fold, RMSE, <span class="at">color=</span>Model)) <span class="sc">+</span></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title=</span><span class="st">"BTC ARIMAX — Rolling CV RMSE"</span>, <span class="at">x=</span><span class="st">"Fold"</span>, <span class="at">y=</span><span class="st">"RMSE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/btc-cv-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Mean RMSE → Auto: %.5f | Manual: %.5f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(rmse_auto, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="fu">mean</span>(rmse_manual, <span class="at">na.rm=</span><span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean RMSE → Auto: 0.02625 | Manual: 0.02625</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>best_is_auto <span class="ot">&lt;-</span> <span class="fu">mean</span>(rmse_auto, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="sc">&lt;=</span> <span class="fu">mean</span>(rmse_manual, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Chosen by CV: %s</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">ifelse</span>(best_is_auto, <span class="st">"AUTO.ARIMA"</span>, <span class="st">"MANUAL ARIMAX"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Chosen by CV: AUTO.ARIMA</code></pre>
</div>
</div>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>best_model <span class="ot">&lt;-</span> <span class="cf">if</span> (best_is_auto) m_btc_auto <span class="cf">else</span> m_btc_manual</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Final chosen model summary:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(best_model))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final chosen model summary:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y 
Regression with ARIMA(0,0,1) errors 

Coefficients:
          ma1  intercept  SP500_ret  VIX_ret
      -0.0509      2e-03     0.0106  -0.0014
s.e.   0.0239      9e-04     0.0014   0.0014

sigma^2 = 0.001532:  log likelihood = 3038.74
AIC=-6067.48   AICc=-6067.44   BIC=-6040.38

Training set error measures:
                        ME       RMSE        MAE      MPE     MAPE      MASE
Training set -2.889967e-07 0.03909278 0.02628258 84.64458 181.4527 0.6305882
                     ACF1
Training set -0.001210254</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Diagnostics</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a>resid_b <span class="ot">&lt;-</span> <span class="fu">residuals</span>(best_model)</span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(resid_b, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">main=</span><span class="st">"Residuals"</span>, <span class="at">ylab=</span><span class="cn">NULL</span>); <span class="fu">abline</span>(<span class="at">h=</span><span class="dv">0</span>, <span class="at">lty=</span><span class="dv">2</span>); <span class="fu">grid</span>()</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(resid_b, <span class="at">main=</span><span class="st">"Residual ACF"</span>); <span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/btc-model-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>lb <span class="ot">&lt;-</span> <span class="fu">Box.test</span>(resid_b, <span class="at">lag =</span> <span class="dv">20</span>, <span class="at">type =</span> <span class="st">"Ljung-Box"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Ljung-Box p (lag=20): %.4f</span><span class="sc">\n</span><span class="st">"</span>, lb<span class="sc">$</span>p.value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Ljung-Box p (lag=20): 0.2697</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Equation print (regression part only)</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>co <span class="ot">&lt;-</span> <span class="fu">coef</span>(best_model)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>b_spx <span class="ot">&lt;-</span> co[<span class="fu">grep</span>(<span class="st">"SP500_ret"</span>, <span class="fu">names</span>(co))]</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>b_vix <span class="ot">&lt;-</span> co[<span class="fu">grep</span>(<span class="st">"VIX_ret"</span>, <span class="fu">names</span>(co))]</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Regression portion (on standardized xreg):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression portion (on standardized xreg):</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"BTC_ret_t = %.4f·SP500_ret_std_t %+ .4f·VIX_ret_std_t + ARMA errors</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(<span class="fu">length</span>(b_spx)<span class="sc">==</span><span class="dv">0</span>, <span class="dv">0</span>, b_spx),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(<span class="fu">length</span>(b_vix)<span class="sc">==</span><span class="dv">0</span>, <span class="dv">0</span>, b_vix)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>BTC_ret_t = 0.0106·SP500_ret_std_t -0.0014·VIX_ret_std_t + ARMA errors</code></pre>
</div>
</div>
</div>
<div id="tabset-1-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-6-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>H <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast exogenous returns first</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>spx_fc <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">forecast</span>(<span class="fu">auto.arima</span>(returns<span class="sc">$</span>SP500_ret), <span class="at">h =</span> H)<span class="sc">$</span>mean</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>vix_fc <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">forecast</span>(<span class="fu">auto.arima</span>(returns<span class="sc">$</span>VIX_ret),   <span class="at">h =</span> H)<span class="sc">$</span>mean</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>Xfut   <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">SP500_ret =</span> <span class="fu">as.numeric</span>(spx_fc), <span class="at">VIX_ret =</span> <span class="fu">as.numeric</span>(vix_fc))</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># scale with training attributes from XS</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>XfutS <span class="ot">&lt;-</span> <span class="fu">scale</span>(Xfut,</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a><span class="at">center =</span> <span class="fu">attr</span>(<span class="fu">scale</span>(<span class="fu">as.matrix</span>(returns[,<span class="fu">c</span>(<span class="st">"SP500_ret"</span>,<span class="st">"VIX_ret"</span>)])), <span class="st">"scaled:center"</span>),</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="at">scale  =</span> <span class="fu">attr</span>(<span class="fu">scale</span>(<span class="fu">as.matrix</span>(returns[,<span class="fu">c</span>(<span class="st">"SP500_ret"</span>,<span class="st">"VIX_ret"</span>)])), <span class="st">"scaled:scale"</span>))</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>btc_ret_fc <span class="ot">&lt;-</span> <span class="fu">forecast</span>(best_model, <span class="at">xreg =</span> XfutS, <span class="at">h =</span> H)</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(btc_ret_fc, <span class="at">main=</span><span class="st">"BTC Return Forecast — chosen ARIMAX"</span>); <span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/btc-forecast-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert return forecast to a *price level* path (for intuition)</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>last_lvl <span class="ot">&lt;-</span> <span class="fu">tail</span>(price_data<span class="sc">$</span>Bitcoin, <span class="dv">1</span>)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>lvl_path <span class="ot">&lt;-</span> last_lvl <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">cumsum</span>(<span class="fu">as.numeric</span>(btc_ret_fc<span class="sc">$</span>mean)))</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="co"># quick level-path plot</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>op <span class="ot">&lt;-</span> <span class="fu">par</span>(<span class="at">mar=</span><span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>,<span class="dv">3</span>,<span class="dv">1</span>))</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(lvl_path, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">xlab=</span><span class="st">"Forecast Step"</span>, <span class="at">ylab=</span><span class="st">"BTC Level (approx.)"</span>,</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="at">main=</span><span class="st">"BTC Level Path (from return forecasts)"</span>)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/btc-forecast-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(op)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Last observed BTC level: %.2f</span><span class="sc">\n</span><span class="st">"</span>, last_lvl))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Last observed BTC level: 115690.55</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Forecasted BTC level at step %d: %.2f</span><span class="sc">\n</span><span class="st">"</span>, H, <span class="fu">tail</span>(lvl_path,<span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Forecasted BTC level at step 30: 122879.60</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="sp-500" class="level2">
<h2 class="anchored" data-anchor-id="sp-500">S&amp;P 500</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-2-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-1" role="tab" aria-controls="tabset-2-1" aria-selected="true">Visualization</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-2" role="tab" aria-controls="tabset-2-2" aria-selected="false">Variable Selection</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-3" role="tab" aria-controls="tabset-2-3" aria-selected="false">Initial Selection</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-4" role="tab" aria-controls="tabset-2-4" aria-selected="false">Cross Validation</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-5" role="tab" aria-controls="tabset-2-5" aria-selected="false">Model Creation</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-2-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-2-6" role="tab" aria-controls="tabset-2-6" aria-selected="false">Forecasting</a></li></ul>
<div class="tab-content">
<div id="tabset-2-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-2-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(price_data, <span class="fu">aes</span>(Date, SP500)) <span class="sc">+</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"S&amp;P 500 (Level)"</span>, <span class="at">x=</span><span class="cn">NULL</span>, <span class="at">y=</span><span class="cn">NULL</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(returns, <span class="fu">aes</span>(Date, SP500_ret)) <span class="sc">+</span></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"S&amp;P 500 (Log-Returns)"</span>, <span class="at">x=</span><span class="cn">NULL</span>, <span class="at">y=</span><span class="cn">NULL</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(p1, p2, <span class="at">nrow=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-9-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-2-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>cm_spx <span class="ot">&lt;-</span> <span class="fu">cor</span>(returns[, <span class="fu">c</span>(<span class="st">"SP500_ret"</span>,<span class="st">"Bitcoin_ret"</span>,<span class="st">"VIX_ret"</span>)], <span class="at">use=</span><span class="st">"complete.obs"</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">round</span>(cm_spx, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            SP500_ret Bitcoin_ret VIX_ret
SP500_ret       1.000       0.283  -0.728
Bitcoin_ret     0.283       1.000  -0.221
VIX_ret        -0.728      -0.221   1.000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>adf_spx <span class="ot">&lt;-</span> tseries<span class="sc">::</span><span class="fu">adf.test</span>(returns<span class="sc">$</span>SP500_ret)</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>adf_btc <span class="ot">&lt;-</span> tseries<span class="sc">::</span><span class="fu">adf.test</span>(returns<span class="sc">$</span>Bitcoin_ret)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>adf_vix <span class="ot">&lt;-</span> tseries<span class="sc">::</span><span class="fu">adf.test</span>(returns<span class="sc">$</span>VIX_ret)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"ADF p-values → SPX: %.4f | BTC: %.4f | VIX: %.4f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>adf_spx<span class="sc">$</span>p.value, adf_btc<span class="sc">$</span>p.value, adf_vix<span class="sc">$</span>p.value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>ADF p-values → SPX: 0.0100 | BTC: 0.0100 | VIX: 0.0100</code></pre>
</div>
</div>
</div>
<div id="tabset-2-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>y2   <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(returns<span class="sc">$</span>SP500_ret)</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>X2   <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(returns[, <span class="fu">c</span>(<span class="st">"Bitcoin_ret"</span>,<span class="st">"VIX_ret"</span>)])  <span class="co"># exog: BTC, VIX returns</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>X2S  <span class="ot">&lt;-</span> <span class="fu">scale</span>(X2)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>m_spx_auto <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">auto.arima</span>(y2, <span class="at">xreg =</span> X2S, <span class="at">seasonal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AUTO.ARIMA (SPX) summary:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(m_spx_auto))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>AUTO.ARIMA (SPX) summary:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y2 
Regression with ARIMA(2,0,2) errors 

Coefficients:
          ar1      ar2     ma1     ma2  intercept  Bitcoin_ret  VIX_ret
      -1.7159  -0.8621  1.5823  0.7008      6e-04       0.0014  -0.0087
s.e.   0.0283   0.0255  0.0402  0.0356      2e-04       0.0002   0.0002

sigma^2 = 6.801e-05:  log likelihood = 5636.05
AIC=-11256.09   AICc=-11256   BIC=-11212.74

Training set error measures:
                        ME        RMSE        MAE     MPE     MAPE     MASE
Training set -7.875776e-07 0.008229595 0.00538296 174.237 394.5584 0.439583
                   ACF1
Training set 0.02334035</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>ols2 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y2 <span class="sc">~</span> X2S)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>res2 <span class="ot">&lt;-</span> <span class="fu">resid</span>(ols2)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>res2_arima <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">auto.arima</span>(res2, <span class="at">seasonal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>ord2 <span class="ot">&lt;-</span> <span class="fu">arimaorder</span>(res2_arima)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>m_spx_manual <span class="ot">&lt;-</span> <span class="fu">Arima</span>(y2, <span class="at">order =</span> ord2, <span class="at">xreg =</span> X2S, <span class="at">include.mean =</span> <span class="cn">TRUE</span>)</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">MANUAL ARIMAX (SPX) summary:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(m_spx_manual))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
MANUAL ARIMAX (SPX) summary:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y2 
Regression with ARIMA(2,0,2) errors 

Coefficients:
          ar1      ar2     ma1     ma2  intercept  Bitcoin_ret  VIX_ret
      -1.7159  -0.8621  1.5823  0.7008      6e-04       0.0014  -0.0087
s.e.   0.0283   0.0255  0.0402  0.0356      2e-04       0.0002   0.0002

sigma^2 = 6.801e-05:  log likelihood = 5636.05
AIC=-11256.09   AICc=-11256   BIC=-11212.74

Training set error measures:
                        ME        RMSE        MAE     MPE     MAPE     MASE
Training set -7.875776e-07 0.008229595 0.00538296 174.237 394.5584 0.439583
                   ACF1
Training set 0.02334035</code></pre>
</div>
</div>
</div>
<div id="tabset-2-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-4-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>H <span class="ot">&lt;-</span> <span class="dv">20</span>; K <span class="ot">&lt;-</span> <span class="dv">10</span>; n2 <span class="ot">&lt;-</span> <span class="fu">length</span>(y2)</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>rmse_auto2 <span class="ot">&lt;-</span> <span class="fu">c</span>(); rmse_manual2 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>tr_end <span class="ot">&lt;-</span> n2 <span class="sc">-</span> H<span class="sc">*</span>(K <span class="sc">-</span> i <span class="sc">+</span> <span class="dv">1</span>); <span class="cf">if</span> (tr_end <span class="sc">&lt;</span> <span class="dv">250</span>) <span class="cf">break</span></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>y_tr <span class="ot">&lt;-</span> y2[<span class="dv">1</span><span class="sc">:</span>tr_end]; y_te <span class="ot">&lt;-</span> y2[(tr_end<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(tr_end<span class="sc">+</span>H)]</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>X_tr <span class="ot">&lt;-</span> X2S[<span class="dv">1</span><span class="sc">:</span>tr_end, , drop<span class="ot">=</span><span class="cn">FALSE</span>]; X_te <span class="ot">&lt;-</span> X2S[(tr_end<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(tr_end<span class="sc">+</span>H), , drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>fa <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">auto.arima</span>(y_tr, <span class="at">xreg =</span> X_tr, <span class="at">seasonal =</span> <span class="cn">FALSE</span>), <span class="at">silent=</span><span class="cn">TRUE</span>)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(fa,<span class="st">"try-error"</span>)) {</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>fc <span class="ot">&lt;-</span> <span class="fu">forecast</span>(fa, <span class="at">xreg =</span> X_te, <span class="at">h =</span> H)</span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a>rmse_auto2 <span class="ot">&lt;-</span> <span class="fu">c</span>(rmse_auto2, <span class="fu">sqrt</span>(<span class="fu">mean</span>((y_te <span class="sc">-</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>mean))<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>fm <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">Arima</span>(y_tr, <span class="at">order=</span>ord2, <span class="at">xreg=</span>X_tr, <span class="at">include.mean=</span><span class="cn">TRUE</span>), <span class="at">silent=</span><span class="cn">TRUE</span>)</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(fm,<span class="st">"try-error"</span>)) {</span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a>fc <span class="ot">&lt;-</span> <span class="fu">forecast</span>(fm, <span class="at">xreg =</span> X_te, <span class="at">h =</span> H)</span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>rmse_manual2 <span class="ot">&lt;-</span> <span class="fu">c</span>(rmse_manual2, <span class="fu">sqrt</span>(<span class="fu">mean</span>((y_te <span class="sc">-</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>mean))<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>cv_spx <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Fold=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(<span class="fu">length</span>(rmse_auto2),<span class="fu">length</span>(rmse_manual2)),</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a><span class="at">Auto=</span>rmse_auto2, <span class="at">Manual=</span>rmse_manual2) <span class="sc">|&gt;</span></span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a><span class="fu">pivot_longer</span>(<span class="sc">-</span>Fold, <span class="at">names_to=</span><span class="st">"Model"</span>, <span class="at">values_to=</span><span class="st">"RMSE"</span>)</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">na.omit</span>(cv_spx), <span class="fu">aes</span>(Fold, RMSE, <span class="at">color=</span>Model)) <span class="sc">+</span></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title=</span><span class="st">"SPX ARIMAX — Rolling CV RMSE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-12-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Mean RMSE → Auto: %.5f | Manual: %.5f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(rmse_auto2, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="fu">mean</span>(rmse_manual2, <span class="at">na.rm=</span><span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean RMSE → Auto: 0.00574 | Manual: 0.00574</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>best_spx_is_auto <span class="ot">&lt;-</span> <span class="fu">mean</span>(rmse_auto2, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="sc">&lt;=</span> <span class="fu">mean</span>(rmse_manual2, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Chosen by CV: %s</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">ifelse</span>(best_spx_is_auto,<span class="st">"AUTO.ARIMA"</span>,<span class="st">"MANUAL ARIMAX"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Chosen by CV: AUTO.ARIMA</code></pre>
</div>
</div>
</div>
<div id="tabset-2-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-5-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>best_spx <span class="ot">&lt;-</span> <span class="cf">if</span> (best_spx_is_auto) m_spx_auto <span class="cf">else</span> m_spx_manual</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Final SPX model summary:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(best_spx))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final SPX model summary:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y2 
Regression with ARIMA(2,0,2) errors 

Coefficients:
          ar1      ar2     ma1     ma2  intercept  Bitcoin_ret  VIX_ret
      -1.7159  -0.8621  1.5823  0.7008      6e-04       0.0014  -0.0087
s.e.   0.0283   0.0255  0.0402  0.0356      2e-04       0.0002   0.0002

sigma^2 = 6.801e-05:  log likelihood = 5636.05
AIC=-11256.09   AICc=-11256   BIC=-11212.74

Training set error measures:
                        ME        RMSE        MAE     MPE     MAPE     MASE
Training set -7.875776e-07 0.008229595 0.00538296 174.237 394.5584 0.439583
                   ACF1
Training set 0.02334035</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>resid_spx <span class="ot">&lt;-</span> <span class="fu">residuals</span>(best_spx)</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(resid_spx, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">main=</span><span class="st">"SPX Residuals"</span>); <span class="fu">abline</span>(<span class="at">h=</span><span class="dv">0</span>,<span class="at">lty=</span><span class="dv">2</span>); <span class="fu">grid</span>()</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(resid_spx, <span class="at">main=</span><span class="st">"Residual ACF"</span>); <span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-13-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>lb2 <span class="ot">&lt;-</span> <span class="fu">Box.test</span>(resid_spx, <span class="at">lag=</span><span class="dv">20</span>, <span class="at">type=</span><span class="st">"Ljung-Box"</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Ljung-Box p (lag=20): %.4f</span><span class="sc">\n</span><span class="st">"</span>, lb2<span class="sc">$</span>p.value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Ljung-Box p (lag=20): 0.0001</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>co2 <span class="ot">&lt;-</span> <span class="fu">coef</span>(best_spx)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>b_btc <span class="ot">&lt;-</span> co2[<span class="fu">grep</span>(<span class="st">"Bitcoin_ret"</span>, <span class="fu">names</span>(co2))]</span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>b_vix <span class="ot">&lt;-</span> co2[<span class="fu">grep</span>(<span class="st">"VIX_ret"</span>, <span class="fu">names</span>(co2))]</span>
<span id="cb57-4"><a href="#cb57-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Regression portion (standardized xreg):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression portion (standardized xreg):</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"SPX_ret_t = %.4f·BTC_ret_std_t %+ .4f·VIX_ret_std_t + ARMA errors</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(<span class="fu">length</span>(b_btc)<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,b_btc),</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(<span class="fu">length</span>(b_vix)<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,b_vix)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>SPX_ret_t = 0.0014·BTC_ret_std_t -0.0087·VIX_ret_std_t + ARMA errors</code></pre>
</div>
</div>
</div>
<div id="tabset-2-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-2-6-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>H <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast exogenous BTC &amp; VIX returns</span></span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>btc_fc2 <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">forecast</span>(<span class="fu">auto.arima</span>(returns<span class="sc">$</span>Bitcoin_ret), <span class="at">h =</span> H)<span class="sc">$</span>mean</span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>vix_fc2 <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">forecast</span>(<span class="fu">auto.arima</span>(returns<span class="sc">$</span>VIX_ret),     <span class="at">h =</span> H)<span class="sc">$</span>mean</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a>Xfut2   <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">Bitcoin_ret =</span> <span class="fu">as.numeric</span>(btc_fc2), <span class="at">VIX_ret =</span> <span class="fu">as.numeric</span>(vix_fc2))</span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-9"><a href="#cb61-9" aria-hidden="true" tabindex="-1"></a>Xfut2S <span class="ot">&lt;-</span> <span class="fu">scale</span>(Xfut2,</span>
<span id="cb61-10"><a href="#cb61-10" aria-hidden="true" tabindex="-1"></a><span class="at">center =</span> <span class="fu">attr</span>(<span class="fu">scale</span>(<span class="fu">as.matrix</span>(returns[,<span class="fu">c</span>(<span class="st">"Bitcoin_ret"</span>,<span class="st">"VIX_ret"</span>)])), <span class="st">"scaled:center"</span>),</span>
<span id="cb61-11"><a href="#cb61-11" aria-hidden="true" tabindex="-1"></a><span class="at">scale  =</span> <span class="fu">attr</span>(<span class="fu">scale</span>(<span class="fu">as.matrix</span>(returns[,<span class="fu">c</span>(<span class="st">"Bitcoin_ret"</span>,<span class="st">"VIX_ret"</span>)])), <span class="st">"scaled:scale"</span>))</span>
<span id="cb61-12"><a href="#cb61-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-13"><a href="#cb61-13" aria-hidden="true" tabindex="-1"></a>spx_ret_fc <span class="ot">&lt;-</span> <span class="fu">forecast</span>(best_spx, <span class="at">xreg =</span> Xfut2S, <span class="at">h =</span> H)</span>
<span id="cb61-14"><a href="#cb61-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(spx_ret_fc, <span class="at">main=</span><span class="st">"SPX Return Forecast — chosen ARIMAX"</span>); <span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>last_spx <span class="ot">&lt;-</span> <span class="fu">tail</span>(price_data<span class="sc">$</span>SP500,<span class="dv">1</span>)</span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>spx_level_path <span class="ot">&lt;-</span> last_spx <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">cumsum</span>(<span class="fu">as.numeric</span>(spx_ret_fc<span class="sc">$</span>mean)))</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(spx_level_path, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">xlab=</span><span class="st">"Forecast Step"</span>, <span class="at">ylab=</span><span class="st">"SPX Level (approx.)"</span>,</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a><span class="at">main=</span><span class="st">"SPX Level Path (from return forecasts)"</span>); <span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-14-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Last SPX level: %.2f | Forecasted level @%d: %.2f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>last_spx, H, <span class="fu">tail</span>(spx_level_path,<span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Last SPX level: 6631.96 | Forecasted level @30: 6694.15</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="vix" class="level2">
<h2 class="anchored" data-anchor-id="vix">VIX</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-3-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-1" role="tab" aria-controls="tabset-3-1" aria-selected="true">Visualization</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-2" role="tab" aria-controls="tabset-3-2" aria-selected="false">Variable Selection</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-3" role="tab" aria-controls="tabset-3-3" aria-selected="false">Initial selection</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-4" role="tab" aria-controls="tabset-3-4" aria-selected="false">Cross Validation</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-5" role="tab" aria-controls="tabset-3-5" aria-selected="false">Model Creation</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-3-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-3-6" role="tab" aria-controls="tabset-3-6" aria-selected="false">Forecasting</a></li></ul>
<div class="tab-content">
<div id="tabset-3-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-3-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(price_data, <span class="fu">aes</span>(Date, VIX)) <span class="sc">+</span></span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"VIX (Level)"</span>, <span class="at">x=</span><span class="cn">NULL</span>, <span class="at">y=</span><span class="cn">NULL</span>)</span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(returns, <span class="fu">aes</span>(Date, VIX_ret)) <span class="sc">+</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span> <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"VIX (Log-Returns)"</span>, <span class="at">x=</span><span class="cn">NULL</span>, <span class="at">y=</span><span class="cn">NULL</span>)</span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(p1, p2, <span class="at">nrow=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-15-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-3-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>cm_vix <span class="ot">&lt;-</span> <span class="fu">cor</span>(returns[, <span class="fu">c</span>(<span class="st">"VIX_ret"</span>,<span class="st">"Bitcoin_ret"</span>,<span class="st">"SP500_ret"</span>)], <span class="at">use=</span><span class="st">"complete.obs"</span>)</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">round</span>(cm_vix, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            VIX_ret Bitcoin_ret SP500_ret
VIX_ret       1.000      -0.221    -0.728
Bitcoin_ret  -0.221       1.000     0.283
SP500_ret    -0.728       0.283     1.000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>adf_vix <span class="ot">&lt;-</span> tseries<span class="sc">::</span><span class="fu">adf.test</span>(returns<span class="sc">$</span>VIX_ret)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>adf_btc <span class="ot">&lt;-</span> tseries<span class="sc">::</span><span class="fu">adf.test</span>(returns<span class="sc">$</span>Bitcoin_ret)</span>
<span id="cb68-3"><a href="#cb68-3" aria-hidden="true" tabindex="-1"></a>adf_spx <span class="ot">&lt;-</span> tseries<span class="sc">::</span><span class="fu">adf.test</span>(returns<span class="sc">$</span>SP500_ret)</span>
<span id="cb68-4"><a href="#cb68-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"ADF p-values → VIX: %.4f | BTC: %.4f | SPX: %.4f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb68-5"><a href="#cb68-5" aria-hidden="true" tabindex="-1"></a>adf_vix<span class="sc">$</span>p.value, adf_btc<span class="sc">$</span>p.value, adf_spx<span class="sc">$</span>p.value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>ADF p-values → VIX: 0.0100 | BTC: 0.0100 | SPX: 0.0100</code></pre>
</div>
</div>
</div>
<div id="tabset-3-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>y3   <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(returns<span class="sc">$</span>VIX_ret)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>X3   <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(returns[, <span class="fu">c</span>(<span class="st">"Bitcoin_ret"</span>,<span class="st">"SP500_ret"</span>)])  <span class="co"># exog: BTC, SPX returns</span></span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>X3S  <span class="ot">&lt;-</span> <span class="fu">scale</span>(X3)</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>m_vix_auto <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">auto.arima</span>(y3, <span class="at">xreg =</span> X3S, <span class="at">seasonal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AUTO.ARIMA (VIX) summary:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(m_vix_auto))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>AUTO.ARIMA (VIX) summary:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y3 
Regression with ARIMA(3,0,4) errors 

Coefficients:
          ar1     ar2     ar3     ma1      ma2      ma3      ma4  Bitcoin_ret
      -0.4140  0.5175  0.3446  0.2941  -0.5678  -0.3391  -0.1049      -0.0004
s.e.   0.1754  0.0833  0.1464  0.1749   0.0892   0.1515   0.0353       0.0013
      SP500_ret
        -0.0587
s.e.     0.0014

sigma^2 = 0.002838:  log likelihood = 2527.27
AIC=-5034.53   AICc=-5034.4   BIC=-4980.35

Training set error measures:
                        ME       RMSE        MAE MPE MAPE      MASE
Training set -0.0004983514 0.05312771 0.03700709 NaN  Inf 0.4536262
                     ACF1
Training set 0.0001232169</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>ols3 <span class="ot">&lt;-</span> <span class="fu">lm</span>(y3 <span class="sc">~</span> X3S)</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>res3 <span class="ot">&lt;-</span> <span class="fu">resid</span>(ols3)</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>res3_arima <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">auto.arima</span>(res3, <span class="at">seasonal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>ord3 <span class="ot">&lt;-</span> <span class="fu">arimaorder</span>(res3_arima)</span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>m_vix_manual <span class="ot">&lt;-</span> <span class="fu">Arima</span>(y3, <span class="at">order =</span> ord3, <span class="at">xreg =</span> X3S, <span class="at">include.mean =</span> <span class="cn">TRUE</span>)</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">MANUAL ARIMAX (VIX) summary:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(m_vix_manual))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
MANUAL ARIMAX (VIX) summary:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y3 
Regression with ARIMA(3,0,4) errors 

Coefficients:
          ar1     ar2     ar3     ma1      ma2      ma3      ma4  intercept
      -0.4147  0.5179  0.3456  0.2947  -0.5685  -0.3401  -0.1048     -2e-04
s.e.   0.1752  0.0832  0.1462  0.1748   0.0891   0.1513   0.0353      7e-04
      Bitcoin_ret  SP500_ret
          -0.0004    -0.0587
s.e.       0.0013     0.0014

sigma^2 = 0.002839:  log likelihood = 2527.34
AIC=-5032.67   AICc=-5032.51   BIC=-4973.07

Training set error measures:
                       ME       RMSE        MAE MPE MAPE      MASE         ACF1
Training set -1.34067e-05 0.05312549 0.03696717 NaN  Inf 0.4531368 0.0001913375</code></pre>
</div>
</div>
</div>
<div id="tabset-3-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-4-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>H <span class="ot">&lt;-</span> <span class="dv">20</span>; K <span class="ot">&lt;-</span> <span class="dv">10</span>; n3 <span class="ot">&lt;-</span> <span class="fu">length</span>(y3)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>rmse_auto3 <span class="ot">&lt;-</span> <span class="fu">c</span>(); rmse_manual3 <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>tr_end <span class="ot">&lt;-</span> n3 <span class="sc">-</span> H<span class="sc">*</span>(K <span class="sc">-</span> i <span class="sc">+</span> <span class="dv">1</span>); <span class="cf">if</span> (tr_end <span class="sc">&lt;</span> <span class="dv">250</span>) <span class="cf">break</span></span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>y_tr <span class="ot">&lt;-</span> y3[<span class="dv">1</span><span class="sc">:</span>tr_end]; y_te <span class="ot">&lt;-</span> y3[(tr_end<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(tr_end<span class="sc">+</span>H)]</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>X_tr <span class="ot">&lt;-</span> X3S[<span class="dv">1</span><span class="sc">:</span>tr_end, , drop<span class="ot">=</span><span class="cn">FALSE</span>]; X_te <span class="ot">&lt;-</span> X3S[(tr_end<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(tr_end<span class="sc">+</span>H), , drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>fa <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">auto.arima</span>(y_tr, <span class="at">xreg =</span> X_tr, <span class="at">seasonal =</span> <span class="cn">FALSE</span>), <span class="at">silent=</span><span class="cn">TRUE</span>)</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(fa,<span class="st">"try-error"</span>)) {</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>fc <span class="ot">&lt;-</span> <span class="fu">forecast</span>(fa, <span class="at">xreg =</span> X_te, <span class="at">h =</span> H)</span>
<span id="cb76-11"><a href="#cb76-11" aria-hidden="true" tabindex="-1"></a>rmse_auto3 <span class="ot">&lt;-</span> <span class="fu">c</span>(rmse_auto3, <span class="fu">sqrt</span>(<span class="fu">mean</span>((y_te <span class="sc">-</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>mean))<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb76-12"><a href="#cb76-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb76-13"><a href="#cb76-13" aria-hidden="true" tabindex="-1"></a>fm <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">Arima</span>(y_tr, <span class="at">order=</span>ord3, <span class="at">xreg=</span>X_tr, <span class="at">include.mean=</span><span class="cn">TRUE</span>), <span class="at">silent=</span><span class="cn">TRUE</span>)</span>
<span id="cb76-14"><a href="#cb76-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(fm,<span class="st">"try-error"</span>)) {</span>
<span id="cb76-15"><a href="#cb76-15" aria-hidden="true" tabindex="-1"></a>fc <span class="ot">&lt;-</span> <span class="fu">forecast</span>(fm, <span class="at">xreg =</span> X_te, <span class="at">h =</span> H)</span>
<span id="cb76-16"><a href="#cb76-16" aria-hidden="true" tabindex="-1"></a>rmse_manual3 <span class="ot">&lt;-</span> <span class="fu">c</span>(rmse_manual3, <span class="fu">sqrt</span>(<span class="fu">mean</span>((y_te <span class="sc">-</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>mean))<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb76-17"><a href="#cb76-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb76-18"><a href="#cb76-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb76-19"><a href="#cb76-19" aria-hidden="true" tabindex="-1"></a>cv_vix <span class="ot">&lt;-</span> <span class="fu">tibble</span>(<span class="at">Fold=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(<span class="fu">length</span>(rmse_auto3),<span class="fu">length</span>(rmse_manual3)),</span>
<span id="cb76-20"><a href="#cb76-20" aria-hidden="true" tabindex="-1"></a><span class="at">Auto=</span>rmse_auto3, <span class="at">Manual=</span>rmse_manual3) <span class="sc">|&gt;</span></span>
<span id="cb76-21"><a href="#cb76-21" aria-hidden="true" tabindex="-1"></a><span class="fu">pivot_longer</span>(<span class="sc">-</span>Fold, <span class="at">names_to=</span><span class="st">"Model"</span>, <span class="at">values_to=</span><span class="st">"RMSE"</span>)</span>
<span id="cb76-22"><a href="#cb76-22" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">na.omit</span>(cv_vix), <span class="fu">aes</span>(Fold, RMSE, <span class="at">color=</span>Model)) <span class="sc">+</span></span>
<span id="cb76-23"><a href="#cb76-23" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb76-24"><a href="#cb76-24" aria-hidden="true" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title=</span><span class="st">"VIX ARIMAX — Rolling CV RMSE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-18-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Mean RMSE → Auto: %.5f | Manual: %.5f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(rmse_auto3, <span class="at">na.rm=</span><span class="cn">TRUE</span>), <span class="fu">mean</span>(rmse_manual3, <span class="at">na.rm=</span><span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean RMSE → Auto: 0.04964 | Manual: 0.04936</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>best_vix_is_auto <span class="ot">&lt;-</span> <span class="fu">mean</span>(rmse_auto3, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="sc">&lt;=</span> <span class="fu">mean</span>(rmse_manual3, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Chosen by CV: %s</span><span class="sc">\n</span><span class="st">"</span>, <span class="fu">ifelse</span>(best_vix_is_auto,<span class="st">"AUTO.ARIMA"</span>,<span class="st">"MANUAL ARIMAX"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Chosen by CV: MANUAL ARIMAX</code></pre>
</div>
</div>
</div>
<div id="tabset-3-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-5-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>best_vix <span class="ot">&lt;-</span> <span class="cf">if</span> (best_vix_is_auto) m_vix_auto <span class="cf">else</span> m_vix_manual</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Final VIX model summary:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(best_vix))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final VIX model summary:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y3 
Regression with ARIMA(3,0,4) errors 

Coefficients:
          ar1     ar2     ar3     ma1      ma2      ma3      ma4  intercept
      -0.4147  0.5179  0.3456  0.2947  -0.5685  -0.3401  -0.1048     -2e-04
s.e.   0.1752  0.0832  0.1462  0.1748   0.0891   0.1513   0.0353      7e-04
      Bitcoin_ret  SP500_ret
          -0.0004    -0.0587
s.e.       0.0013     0.0014

sigma^2 = 0.002839:  log likelihood = 2527.34
AIC=-5032.67   AICc=-5032.51   BIC=-4973.07

Training set error measures:
                       ME       RMSE        MAE MPE MAPE      MASE         ACF1
Training set -1.34067e-05 0.05312549 0.03696717 NaN  Inf 0.4531368 0.0001913375</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>resid_vix <span class="ot">&lt;-</span> <span class="fu">residuals</span>(best_vix)</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(resid_vix, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">main=</span><span class="st">"VIX Residuals"</span>); <span class="fu">abline</span>(<span class="at">h=</span><span class="dv">0</span>,<span class="at">lty=</span><span class="dv">2</span>); <span class="fu">grid</span>()</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(resid_vix, <span class="at">main=</span><span class="st">"Residual ACF"</span>); <span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-19-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a>lb3 <span class="ot">&lt;-</span> <span class="fu">Box.test</span>(resid_vix, <span class="at">lag=</span><span class="dv">20</span>, <span class="at">type=</span><span class="st">"Ljung-Box"</span>)</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Ljung-Box p (lag=20): %.4f</span><span class="sc">\n</span><span class="st">"</span>, lb3<span class="sc">$</span>p.value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Ljung-Box p (lag=20): 0.9899</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>co3 <span class="ot">&lt;-</span> <span class="fu">coef</span>(best_vix)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>b_btc3 <span class="ot">&lt;-</span> co3[<span class="fu">grep</span>(<span class="st">"Bitcoin_ret"</span>, <span class="fu">names</span>(co3))]</span>
<span id="cb87-3"><a href="#cb87-3" aria-hidden="true" tabindex="-1"></a>b_spx3 <span class="ot">&lt;-</span> co3[<span class="fu">grep</span>(<span class="st">"SP500_ret"</span>, <span class="fu">names</span>(co3))]</span>
<span id="cb87-4"><a href="#cb87-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Regression portion (standardized xreg):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression portion (standardized xreg):</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"VIX_ret_t = %.4f·BTC_ret_std_t %+ .4f·SPX_ret_std_t + ARMA errors</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(<span class="fu">length</span>(b_btc3)<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,b_btc3),</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(<span class="fu">length</span>(b_spx3)<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,b_spx3)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>VIX_ret_t = -0.0004·BTC_ret_std_t -0.0587·SPX_ret_std_t + ARMA errors</code></pre>
</div>
</div>
</div>
<div id="tabset-3-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-3-6-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>H <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast exogenous BTC &amp; SPX returns</span></span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>btc_fc3 <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">forecast</span>(<span class="fu">auto.arima</span>(returns<span class="sc">$</span>Bitcoin_ret), <span class="at">h =</span> H)<span class="sc">$</span>mean</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>spx_fc3 <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">forecast</span>(<span class="fu">auto.arima</span>(returns<span class="sc">$</span>SP500_ret),  <span class="at">h =</span> H)<span class="sc">$</span>mean</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>Xfut3   <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">Bitcoin_ret =</span> <span class="fu">as.numeric</span>(btc_fc3), <span class="at">SP500_ret =</span> <span class="fu">as.numeric</span>(spx_fc3))</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>Xfut3S <span class="ot">&lt;-</span> <span class="fu">scale</span>(Xfut3,</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a><span class="at">center =</span> <span class="fu">attr</span>(<span class="fu">scale</span>(<span class="fu">as.matrix</span>(returns[,<span class="fu">c</span>(<span class="st">"Bitcoin_ret"</span>,<span class="st">"SP500_ret"</span>)])), <span class="st">"scaled:center"</span>),</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a><span class="at">scale  =</span> <span class="fu">attr</span>(<span class="fu">scale</span>(<span class="fu">as.matrix</span>(returns[,<span class="fu">c</span>(<span class="st">"Bitcoin_ret"</span>,<span class="st">"SP500_ret"</span>)])), <span class="st">"scaled:scale"</span>))</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>vix_ret_fc <span class="ot">&lt;-</span> <span class="fu">forecast</span>(best_vix, <span class="at">xreg =</span> Xfut3S, <span class="at">h =</span> H)</span>
<span id="cb91-14"><a href="#cb91-14" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(vix_ret_fc, <span class="at">main=</span><span class="st">"VIX Return Forecast — chosen ARIMAX"</span>); <span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>last_vix <span class="ot">&lt;-</span> <span class="fu">tail</span>(price_data<span class="sc">$</span>VIX,<span class="dv">1</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>vix_level_path <span class="ot">&lt;-</span> last_vix <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">cumsum</span>(<span class="fu">as.numeric</span>(vix_ret_fc<span class="sc">$</span>mean)))</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(vix_level_path, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">xlab=</span><span class="st">"Forecast Step"</span>, <span class="at">ylab=</span><span class="st">"VIX Level (approx.)"</span>,</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a><span class="at">main=</span><span class="st">"VIX Level Path (from return forecasts)"</span>); <span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-20-2.png" class="img-fluid figure-img" width="960"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Last VIX level: %.2f | Forecasted level @%d: %.2f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>last_vix, H, <span class="fu">tail</span>(vix_level_path,<span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Last VIX level: 15.70 | Forecasted level @30: 15.02</code></pre>
</div>
</div>
</div>
</div>
</div>
</section>
<section id="usd" class="level2">
<h2 class="anchored" data-anchor-id="usd">USD</h2>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-4-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-1" role="tab" aria-controls="tabset-4-1" aria-selected="true">Visualization</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-2" role="tab" aria-controls="tabset-4-2" aria-selected="false">Variable Selection</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-3" role="tab" aria-controls="tabset-4-3" aria-selected="false">Initial Selection</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-4" role="tab" aria-controls="tabset-4-4" aria-selected="false">Cross Validation</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-5" role="tab" aria-controls="tabset-4-5" aria-selected="false">Model Creation</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-4-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-4-6" role="tab" aria-controls="tabset-4-6" aria-selected="false">Forecasting</a></li></ul>
<div class="tab-content">
<div id="tabset-4-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-4-1-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>p1 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(price_data, <span class="fu">aes</span>(Date, USD)) <span class="sc">+</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"USD (Level)"</span>, <span class="at">x=</span><span class="cn">NULL</span>, <span class="at">y=</span><span class="cn">NULL</span>)</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">ggplot</span>(returns, <span class="fu">aes</span>(Date, USD_ret)) <span class="sc">+</span></span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title=</span><span class="st">"USD (Log-Returns)"</span>, <span class="at">x=</span><span class="cn">NULL</span>, <span class="at">y=</span><span class="cn">NULL</span>)</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a>gridExtra<span class="sc">::</span><span class="fu">grid.arrange</span>(p1, p2, <span class="at">nrow=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</div>
<div id="tabset-4-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-2-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>cm_usd <span class="ot">&lt;-</span> <span class="fu">cor</span>(</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>returns[, <span class="fu">c</span>(<span class="st">"USD_ret"</span>,<span class="st">"SP500_ret"</span>,<span class="st">"VIX_ret"</span>,<span class="st">"Bitcoin_ret"</span>)],</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a><span class="at">use=</span><span class="st">"complete.obs"</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">round</span>(cm_usd, <span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>            USD_ret SP500_ret VIX_ret Bitcoin_ret
USD_ret       1.000    -0.307   0.221      -0.165
SP500_ret    -0.307     1.000  -0.728       0.283
VIX_ret       0.221    -0.728   1.000      -0.221
Bitcoin_ret  -0.165     0.283  -0.221       1.000</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>adf_usd <span class="ot">&lt;-</span> tseries<span class="sc">::</span><span class="fu">adf.test</span>(returns<span class="sc">$</span>USD_ret)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stderr">
<pre><code>Warning in tseries::adf.test(returns$USD_ret): p-value smaller than printed
p-value</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"ADF p-value → USD_ret: %.4f</span><span class="sc">\n</span><span class="st">"</span>, adf_usd<span class="sc">$</span>p.value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>ADF p-value → USD_ret: 0.0100</code></pre>
</div>
</div>
</div>
<div id="tabset-4-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-3-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We model USD_ret using Bitcoin_ret + SP500_ret (same structure as VIX or SP500)</span></span>
<span id="cb102-2"><a href="#cb102-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-3"><a href="#cb102-3" aria-hidden="true" tabindex="-1"></a>y_usd <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(returns<span class="sc">$</span>USD_ret)</span>
<span id="cb102-4"><a href="#cb102-4" aria-hidden="true" tabindex="-1"></a>X_usd <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(returns[, <span class="fu">c</span>(<span class="st">"Bitcoin_ret"</span>,<span class="st">"SP500_ret"</span>)])</span>
<span id="cb102-5"><a href="#cb102-5" aria-hidden="true" tabindex="-1"></a>X_usdS <span class="ot">&lt;-</span> <span class="fu">scale</span>(X_usd)</span>
<span id="cb102-6"><a href="#cb102-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-7"><a href="#cb102-7" aria-hidden="true" tabindex="-1"></a><span class="co"># AUTO.ARIMA</span></span>
<span id="cb102-8"><a href="#cb102-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb102-9"><a href="#cb102-9" aria-hidden="true" tabindex="-1"></a>m_usd_auto <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">auto.arima</span>(y_usd, <span class="at">xreg =</span> X_usdS, <span class="at">seasonal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb102-10"><a href="#cb102-10" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"AUTO.ARIMA (USD) summary:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(m_usd_auto))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>AUTO.ARIMA (USD) summary:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y_usd 
Regression with ARIMA(0,0,0) errors 

Coefficients:
      Bitcoin_ret  SP500_ret
           -3e-04     -9e-04
s.e.        1e-04      1e-04

sigma^2 = 9.204e-06:  log likelihood = 7300.75
AIC=-14595.49   AICc=-14595.48   BIC=-14579.24

Training set error measures:
                      ME        RMSE       MAE      MPE     MAPE      MASE
Training set 2.20326e-05 0.003032068 0.0022552 4.674679 217.6325 0.6825008
                   ACF1
Training set -0.0181938</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Manual method</span></span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>ols_usd <span class="ot">&lt;-</span> <span class="fu">lm</span>(y_usd <span class="sc">~</span> X_usdS)</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>res_usd <span class="ot">&lt;-</span> <span class="fu">resid</span>(ols_usd)</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>res_usd_arima <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">auto.arima</span>(res_usd, <span class="at">seasonal =</span> <span class="cn">FALSE</span>)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>ord_usd <span class="ot">&lt;-</span> <span class="fu">arimaorder</span>(res_usd_arima)</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>m_usd_manual <span class="ot">&lt;-</span> <span class="fu">Arima</span>(y_usd, <span class="at">order =</span> ord_usd,</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a><span class="at">xreg =</span> X_usdS, <span class="at">include.mean =</span> <span class="cn">TRUE</span>)</span>
<span id="cb105-10"><a href="#cb105-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-11"><a href="#cb105-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">MANUAL ARIMAX (USD) summary:</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
MANUAL ARIMAX (USD) summary:</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">summary</span>(m_usd_manual))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y_usd 
Regression with ARIMA(3,0,1) errors 

Coefficients:
          ar1      ar2     ar3     ma1  intercept  Bitcoin_ret  SP500_ret
      -0.8992  -0.0227  0.0294  0.8847      0e+00       -3e-04     -9e-04
s.e.   0.0524   0.0338  0.0254  0.0463      1e-04        1e-04      1e-04

sigma^2 = 9.178e-06:  log likelihood = 7305.62
AIC=-14595.24   AICc=-14595.16   BIC=-14551.89

Training set error measures:
                       ME        RMSE         MAE       MPE     MAPE      MASE
Training set 2.214595e-08 0.003023181 0.002250451 -13.98104 235.3292 0.6810637
                     ACF1
Training set 0.0007130133</code></pre>
</div>
</div>
</div>
<div id="tabset-4-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-4-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>H <span class="ot">&lt;-</span> <span class="dv">20</span>; K <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a>n_usd <span class="ot">&lt;-</span> <span class="fu">length</span>(y_usd)</span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>rmse_auto_usd <span class="ot">&lt;-</span> <span class="fu">c</span>(); rmse_manual_usd <span class="ot">&lt;-</span> <span class="fu">c</span>()</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>tr_end <span class="ot">&lt;-</span> n_usd <span class="sc">-</span> H<span class="sc">*</span>(K <span class="sc">-</span> i <span class="sc">+</span> <span class="dv">1</span>)</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (tr_end <span class="sc">&lt;</span> <span class="dv">250</span>) <span class="cf">break</span></span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>y_tr <span class="ot">&lt;-</span> y_usd[<span class="dv">1</span><span class="sc">:</span>tr_end]</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>y_te <span class="ot">&lt;-</span> y_usd[(tr_end<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(tr_end<span class="sc">+</span>H)]</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>X_tr <span class="ot">&lt;-</span> X_usdS[<span class="dv">1</span><span class="sc">:</span>tr_end, , drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>X_te <span class="ot">&lt;-</span> X_usdS[(tr_end<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>(tr_end<span class="sc">+</span>H), , drop<span class="ot">=</span><span class="cn">FALSE</span>]</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>fit_a <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">auto.arima</span>(y_tr, <span class="at">xreg =</span> X_tr, <span class="at">seasonal =</span> <span class="cn">FALSE</span>), <span class="at">silent=</span><span class="cn">TRUE</span>)</span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(fit_a,<span class="st">"try-error"</span>)) {</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>fc <span class="ot">&lt;-</span> <span class="fu">forecast</span>(fit_a, <span class="at">xreg =</span> X_te, <span class="at">h =</span> H)</span>
<span id="cb109-19"><a href="#cb109-19" aria-hidden="true" tabindex="-1"></a>rmse_auto_usd <span class="ot">&lt;-</span> <span class="fu">c</span>(rmse_auto_usd,</span>
<span id="cb109-20"><a href="#cb109-20" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(<span class="fu">mean</span>((y_te <span class="sc">-</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>mean))<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb109-21"><a href="#cb109-21" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb109-22"><a href="#cb109-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-23"><a href="#cb109-23" aria-hidden="true" tabindex="-1"></a>fit_m <span class="ot">&lt;-</span> <span class="fu">try</span>(<span class="fu">Arima</span>(y_tr, <span class="at">order=</span>ord_usd, <span class="at">xreg=</span>X_tr, <span class="at">include.mean=</span><span class="cn">TRUE</span>),</span>
<span id="cb109-24"><a href="#cb109-24" aria-hidden="true" tabindex="-1"></a><span class="at">silent=</span><span class="cn">TRUE</span>)</span>
<span id="cb109-25"><a href="#cb109-25" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">inherits</span>(fit_m,<span class="st">"try-error"</span>)) {</span>
<span id="cb109-26"><a href="#cb109-26" aria-hidden="true" tabindex="-1"></a>fc <span class="ot">&lt;-</span> <span class="fu">forecast</span>(fit_m, <span class="at">xreg =</span> X_te, <span class="at">h =</span> H)</span>
<span id="cb109-27"><a href="#cb109-27" aria-hidden="true" tabindex="-1"></a>rmse_manual_usd <span class="ot">&lt;-</span> <span class="fu">c</span>(rmse_manual_usd,</span>
<span id="cb109-28"><a href="#cb109-28" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(<span class="fu">mean</span>((y_te <span class="sc">-</span> <span class="fu">as.numeric</span>(fc<span class="sc">$</span>mean))<span class="sc">^</span><span class="dv">2</span>)))</span>
<span id="cb109-29"><a href="#cb109-29" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb109-30"><a href="#cb109-30" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb109-31"><a href="#cb109-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-32"><a href="#cb109-32" aria-hidden="true" tabindex="-1"></a>cv_usd <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb109-33"><a href="#cb109-33" aria-hidden="true" tabindex="-1"></a><span class="at">Fold =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">max</span>(<span class="fu">length</span>(rmse_auto_usd),<span class="fu">length</span>(rmse_manual_usd)),</span>
<span id="cb109-34"><a href="#cb109-34" aria-hidden="true" tabindex="-1"></a><span class="at">Auto =</span> rmse_auto_usd,</span>
<span id="cb109-35"><a href="#cb109-35" aria-hidden="true" tabindex="-1"></a><span class="at">Manual =</span> rmse_manual_usd</span>
<span id="cb109-36"><a href="#cb109-36" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span> <span class="fu">pivot_longer</span>(<span class="sc">-</span>Fold, <span class="at">names_to=</span><span class="st">"Model"</span>, <span class="at">values_to=</span><span class="st">"RMSE"</span>)</span>
<span id="cb109-37"><a href="#cb109-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-38"><a href="#cb109-38" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="fu">na.omit</span>(cv_usd), <span class="fu">aes</span>(Fold, RMSE, <span class="at">color=</span>Model)) <span class="sc">+</span></span>
<span id="cb109-39"><a href="#cb109-39" aria-hidden="true" tabindex="-1"></a><span class="fu">geom_line</span>() <span class="sc">+</span> <span class="fu">geom_point</span>(<span class="at">size=</span><span class="dv">2</span>) <span class="sc">+</span> <span class="fu">theme_minimal</span>() <span class="sc">+</span></span>
<span id="cb109-40"><a href="#cb109-40" aria-hidden="true" tabindex="-1"></a><span class="fu">labs</span>(<span class="at">title=</span><span class="st">"USD ARIMAX — Rolling CV RMSE"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-24-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Mean RMSE → Auto: %.5f | Manual: %.5f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(rmse_auto_usd, <span class="at">na.rm=</span><span class="cn">TRUE</span>),</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(rmse_manual_usd, <span class="at">na.rm=</span><span class="cn">TRUE</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Mean RMSE → Auto: 0.00328 | Manual: 0.00329</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>best_usd_is_auto <span class="ot">&lt;-</span> <span class="fu">mean</span>(rmse_auto_usd, <span class="at">na.rm=</span><span class="cn">TRUE</span>) <span class="sc">&lt;=</span></span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mean</span>(rmse_manual_usd, <span class="at">na.rm=</span><span class="cn">TRUE</span>)</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Chosen by CV: %s</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(best_usd_is_auto,<span class="st">"AUTO.ARIMA"</span>,<span class="st">"MANUAL ARIMAX"</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Chosen by CV: AUTO.ARIMA</code></pre>
</div>
</div>
</div>
<div id="tabset-4-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-5-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>best_usd <span class="ot">&lt;-</span> <span class="cf">if</span> (best_usd_is_auto) m_usd_auto <span class="cf">else</span> m_usd_manual</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Final USD model summary:</span><span class="sc">\n</span><span class="st">"</span>); <span class="fu">print</span>(<span class="fu">summary</span>(best_usd))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Final USD model summary:</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Series: y_usd 
Regression with ARIMA(0,0,0) errors 

Coefficients:
      Bitcoin_ret  SP500_ret
           -3e-04     -9e-04
s.e.        1e-04      1e-04

sigma^2 = 9.204e-06:  log likelihood = 7300.75
AIC=-14595.49   AICc=-14595.48   BIC=-14579.24

Training set error measures:
                      ME        RMSE       MAE      MPE     MAPE      MASE
Training set 2.20326e-05 0.003032068 0.0022552 4.674679 217.6325 0.6825008
                   ACF1
Training set -0.0181938</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a>resid_usd <span class="ot">&lt;-</span> <span class="fu">residuals</span>(best_usd)</span>
<span id="cb117-2"><a href="#cb117-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb117-3"><a href="#cb117-3" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(resid_usd, <span class="at">type=</span><span class="st">"l"</span>, <span class="at">main=</span><span class="st">"USD Residuals"</span>); <span class="fu">abline</span>(<span class="at">h=</span><span class="dv">0</span>, <span class="at">lty=</span><span class="dv">2</span>); <span class="fu">grid</span>()</span>
<span id="cb117-4"><a href="#cb117-4" aria-hidden="true" tabindex="-1"></a><span class="fu">acf</span>(resid_usd, <span class="at">main=</span><span class="st">"Residual ACF"</span>); <span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow=</span><span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>lb_usd <span class="ot">&lt;-</span> <span class="fu">Box.test</span>(resid_usd, <span class="at">lag=</span><span class="dv">20</span>, <span class="at">type=</span><span class="st">"Ljung-Box"</span>)</span>
<span id="cb118-4"><a href="#cb118-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Ljung-Box p (lag=20): %.4f</span><span class="sc">\n</span><span class="st">"</span>, lb_usd<span class="sc">$</span>p.value))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Ljung-Box p (lag=20): 0.0020</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>co_usd <span class="ot">&lt;-</span> <span class="fu">coef</span>(best_usd)</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>b_btc_usd <span class="ot">&lt;-</span> co_usd[<span class="fu">grep</span>(<span class="st">"Bitcoin_ret"</span>, <span class="fu">names</span>(co_usd))]</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a>b_spx_usd <span class="ot">&lt;-</span> co_usd[<span class="fu">grep</span>(<span class="st">"SP500_ret"</span>, <span class="fu">names</span>(co_usd))]</span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Regression portion (standardized xreg):</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>
Regression portion (standardized xreg):</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a><span class="st">"USD_ret_t = %.4f·BTC_ret_std_t %+ .4f·SPX_ret_std_t + ARMA errors</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(<span class="fu">length</span>(b_btc_usd)<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,b_btc_usd),</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a><span class="fu">ifelse</span>(<span class="fu">length</span>(b_spx_usd)<span class="sc">==</span><span class="dv">0</span>,<span class="dv">0</span>,b_spx_usd)</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>USD_ret_t = -0.0003·BTC_ret_std_t -0.0009·SPX_ret_std_t + ARMA errors</code></pre>
</div>
</div>
</div>
<div id="tabset-4-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-4-6-tab">
<div class="cell">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a>H <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Forecast BTC &amp; SPX returns as xreg</span></span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>btc_fc_usd <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">forecast</span>(<span class="fu">auto.arima</span>(returns<span class="sc">$</span>Bitcoin_ret), <span class="at">h =</span> H)<span class="sc">$</span>mean</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>spx_fc_usd <span class="ot">&lt;-</span> forecast<span class="sc">::</span><span class="fu">forecast</span>(<span class="fu">auto.arima</span>(returns<span class="sc">$</span>SP500_ret),  <span class="at">h =</span> H)<span class="sc">$</span>mean</span>
<span id="cb124-7"><a href="#cb124-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-8"><a href="#cb124-8" aria-hidden="true" tabindex="-1"></a>Xfut_usd <span class="ot">&lt;-</span> <span class="fu">cbind</span>(<span class="at">Bitcoin_ret =</span> <span class="fu">as.numeric</span>(btc_fc_usd),</span>
<span id="cb124-9"><a href="#cb124-9" aria-hidden="true" tabindex="-1"></a><span class="at">SP500_ret   =</span> <span class="fu">as.numeric</span>(spx_fc_usd))</span>
<span id="cb124-10"><a href="#cb124-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-11"><a href="#cb124-11" aria-hidden="true" tabindex="-1"></a>X_train_usd <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(returns[, <span class="fu">c</span>(<span class="st">"Bitcoin_ret"</span>,<span class="st">"SP500_ret"</span>)])</span>
<span id="cb124-12"><a href="#cb124-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-13"><a href="#cb124-13" aria-hidden="true" tabindex="-1"></a>Xfut_usdS <span class="ot">&lt;-</span> <span class="fu">scale</span>(</span>
<span id="cb124-14"><a href="#cb124-14" aria-hidden="true" tabindex="-1"></a>Xfut_usd,</span>
<span id="cb124-15"><a href="#cb124-15" aria-hidden="true" tabindex="-1"></a><span class="at">center =</span> <span class="fu">attr</span>(<span class="fu">scale</span>(X_train_usd),<span class="st">"scaled:center"</span>),</span>
<span id="cb124-16"><a href="#cb124-16" aria-hidden="true" tabindex="-1"></a><span class="at">scale  =</span> <span class="fu">attr</span>(<span class="fu">scale</span>(X_train_usd),<span class="st">"scaled:scale"</span>)</span>
<span id="cb124-17"><a href="#cb124-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb124-18"><a href="#cb124-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb124-19"><a href="#cb124-19" aria-hidden="true" tabindex="-1"></a>usd_ret_fc <span class="ot">&lt;-</span> <span class="fu">forecast</span>(best_usd, <span class="at">xreg =</span> Xfut_usdS, <span class="at">h =</span> H)</span>
<span id="cb124-20"><a href="#cb124-20" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(usd_ret_fc, <span class="at">main=</span><span class="st">"USD Return Forecast — chosen ARIMAX"</span>); <span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-26-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>last_usd <span class="ot">&lt;-</span> <span class="fu">tail</span>(price_data<span class="sc">$</span>USD,<span class="dv">1</span>)</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>usd_level_path <span class="ot">&lt;-</span> last_usd <span class="sc">*</span> <span class="fu">exp</span>(<span class="fu">cumsum</span>(<span class="fu">as.numeric</span>(usd_ret_fc<span class="sc">$</span>mean)))</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(usd_level_path, <span class="at">type=</span><span class="st">"l"</span>,</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a><span class="at">main=</span><span class="st">"USD Level Path (from return forecasts)"</span>,</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a><span class="at">xlab=</span><span class="st">"Forecast Step"</span>, <span class="at">ylab=</span><span class="st">"USD Index (approx.)"</span>)</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="multivariate-ts-models_files/figure-html/unnamed-chunk-26-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Last USD level: %.2f</span><span class="sc">\n</span><span class="st">"</span>, last_usd))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Last USD level: 120.10</code></pre>
</div>
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb128"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb128-1"><a href="#cb128-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">sprintf</span>(<span class="st">"Forecasted USD level @%d: %.2f</span><span class="sc">\n</span><span class="st">"</span>,</span>
<span id="cb128-2"><a href="#cb128-2" aria-hidden="true" tabindex="-1"></a>H, <span class="fu">tail</span>(usd_level_path,<span class="dv">1</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Forecasted USD level @30: 120.10</code></pre>
</div>
</div>
<p>Cross-asset predictability is weak across all models. SPX is strongly driven by VIX (fear), but Bitcoin has only tiny, insignificant dependencies on SPX or VIX, and USD is essentially unaffected by any other asset. Overall, the equity–volatility relationship dominates, while Bitcoin and USD remain mostly independent.</p>


</div>
</div>
</div>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/YOUR_GH_USERNAME\.github\.io\/time-series\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>